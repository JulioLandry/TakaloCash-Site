<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TakaloCash – Service</title>
<style>
  :root{
    --brand:#ffbf00;        /* volamena */
    --brand-2:#d9a300;
    --dark:#0c0c0c;
    --ink:#222;
    --muted:#6d6d6d;
    --grey:#f5f5f5;
    --ok:#16a34a;
    --danger:#dc2626;
    --pill:999px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
  
  /* ===== Header ===== */
  header{background:#0c0c0c;color:#fff;padding:24px 16px 8px;position:sticky;top:0;z-index:10;box-shadow:0 6px 24px rgba(0,0,0,.2)}
  .topbar{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;flex-direction:column}
  .brand .title{font-weight:1000;letter-spacing:.5px;font-size:30px;color:var(--brand)}
  .brand .subtitle{
    margin-top:6px;display:inline-block;padding:6px 12px;background:#eee;color:#111;
    border-radius:8px;font-weight:800;letter-spacing:3px;text-transform:lowercase;
    font-style:italic; text-shadow:0 1px 0 #fff, 0 0 6px rgba(255,191,0,.45);
  }
  .flags{display:flex;gap:8px}
  .flag{width:28px;height:18px;border-radius:3px;overflow:hidden;cursor:pointer;border:1px solid #0003;background:#fff}
  .lang-active{outline:2px solid var(--brand)}
  .tabs{max-width:980px;margin:14px auto 0;display:flex;gap:10px;flex-wrap:wrap;padding:0 4px 10px}
  .tab{background:var(--brand);border:none;color:#111;font-weight:900;padding:10px 18px;border-radius:var(--pill);cursor:pointer;letter-spacing:.5px;font-size:15px;box-shadow:0 3px 0 var(--brand-2)}
  .tab[aria-selected="true"]{background:#111;color:#fff;box-shadow:0 3px 0 #000}
  main{max-width:980px;margin:18px auto;padding:0 12px 80px}

  /* ===== common UI ===== */
  .panel{background:#fff;border:1px solid #eee;border-radius:16px;padding:14px 14px 18px;box-shadow:0 10px 30px rgba(0,0,0,.06);margin-bottom:14px}
  .label{font-size:13px;color:#444;margin-bottom:6px;font-weight:800;letter-spacing:.2px}
  .field{position:relative}
  .field input, .field select, .field textarea{
    width:100%;padding:14px;border-radius:12px;border:1px solid #ddd;background:#f9f9f9;font-size:16px;outline:none
  }
  .field input[readonly]{background:#f3f3f3;color:#333;cursor:not-allowed}
  .suffix{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:800;background:#111;color:#fff;border-radius:10px;padding:4px 8px}
  .prefix{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:800;color:#555;padding:4px 8px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  .note{font-size:12px;color:#333;margin-top:6px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center}
  .pay-opts, .crypto-strip, .ewallet-strip{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 8px}
  .chip, .paybtn, .ewbtn{
    padding:6px 10px;border-radius:14px;background:#111;color:#fff;font-weight:700;font-size:12px;cursor:pointer;border:1px solid #000;user-select:none
  }
  .chip[aria-pressed="true"], .paybtn[aria-pressed="true"], .ewbtn[aria-pressed="true"]{background:var(--brand);color:#111;border-color:#d6a800}
  .expand-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:14px;border:1px dashed #999;background:#fff;color:#111;font-weight:800;cursor:pointer}
  .expand-btn svg{width:14px;height:14px}
  .checkbox{display:flex;gap:8px;align-items:flex-start;margin-top:6px}
  .actions{display:flex;gap:10px;align-items:center;margin-top:10px}
  .btn{border:none;border-radius:16px;padding:12px 16px;font-weight:900;cursor:pointer}
  .btn-primary{background:var(--brand);color:#111}
  .btn-primary:disabled{opacity:.5;cursor:not-allowed}
  .btn-ghost{background:#000;color:#fff}
  .copybtn{border:none;border-radius:10px;padding:10px 12px;background:#111;color:#fff;cursor:pointer;font-weight:800}

  /* Toast & confirm */
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);display:none;z-index:50}
  .toast.show{display:block}
  dialog{border:none;border-radius:16px;padding:18px;max-width:720px;width:92%}
  dialog::backdrop{background:rgba(0,0,0,.5)}

  /* ===== footer ===== */
  footer{background:#111;color:#fff;padding:24px 12px 40px}
  .footer-wrap{max-width:980px;margin:0 auto}
  .contact-title{font-weight:1000;letter-spacing:.3px;margin-bottom:8px}
  .cta{display:flex;gap:12px;flex-wrap:wrap}
  .ctaitem{display:inline-flex;align-items:center;gap:8px;background:#fff;color:#111;border-radius:12px;padding:8px 12px;font-weight:900;cursor:pointer}
  .ctaitem[data-kind="fb"]{background:#1877f2;color:#fff}
  .ctaitem[data-kind="wa"]{background:#25D366;color:#fff}
  .ctaitem svg{width:18px;height:18px}
  .legal{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
  .legal a{color:#9ad3ff;text-decoration:underline;cursor:pointer}
  .copy{font-size:12px;color:#ddd;margin-top:12px}

  /* Nouveaux styles pour les améliorations */
  .payment-source, .payment-destination {
    background: var(--grey);
    padding: 12px;
    border-radius: 12px;
    margin-bottom: 16px;
  }
  .payment-source h3, .payment-destination h3 {
    margin-top: 0;
    font-size: 14px;
    color: var(--muted);
  }
  .crypto-strip h3, .ewallet-strip h3 {
    margin: 0 0 8px 0;
    font-size: 14px;
    color: var(--muted);
  }
  .crypto {
    padding: 8px 12px;
    background: #111;
    color: white;
    border-radius: 12px;
    cursor: pointer;
  }
  .crypto:hover {
    background: var(--brand);
    color: #111;
  }
</style>
</head>
<body>

<header>
  <div class="topbar">
    <div class="brand">
      <div class="title">TAKALOCASH</div>
      <div class="subtitle">Simple – rapide – sécurisé</div>
    </div>
    <div class="flags" aria-label="Language">
      <button class="flag lang-active" id="lang-fr" aria-pressed="true" title="Français">
        <svg viewBox="0 0 3 2" width="28" height="18">
          <rect width="1" height="2" x="0" y="0" fill="#0055a4"/>
          <rect width="1" height="2" x="1" y="0" fill="#fff"/>
          <rect width="1" height="2" x="2" y="0" fill="#ef4135"/>
        </svg>
      </button>
      <button class="flag" id="lang-mg" aria-pressed="false" title="Malagasy">
        <svg viewBox="0 0 3 2" width="28" height="18">
          <rect width="1" height="2" x="0" y="0" fill="#ffffff"/>
          <rect width="2" height="1" x="1" y="0" fill="#fc3d32"/>
          <rect width="2" height="1" x="1" y="1" fill="#007e3a"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="tabs" role="tablist" aria-label="Service">
    <button class="tab" role="tab" id="tab-depot" aria-selected="true" data-tab="depot">DÉPÔT</button>
    <button class="tab" role="tab" id="tab-retrait" aria-selected="false" data-tab="retrait">RETRAIT</button>
    <button class="tab" role="tab" id="tab-transfert" aria-selected="false" data-tab="transfert">TRANSFERT</button>
  </div>
</header>

<main>
  <!-- ================== DEPOT ================== -->
  <section id="panel-depot" class="panel" role="tabpanel" aria-labelledby="tab-depot">
    <div class="payment-source">
      <h3>Source : Mobile Money</h3>
      <div class="pay-opts" id="dep-pay-opts">
        <button class="paybtn" data-pay="mvola" aria-pressed="true">Mvola</button>
        <button class="paybtn" data-pay="orange">Orange Money</button>
        <button class="paybtn" data-pay="airtel">Airtel Money</button>
      </div>
      <div class="note muted" id="dep-pay-hint">
        Envoyer à <span class="chip" id="dep-pay-dest">0347451051</span> — Nom: <b id="dep-pay-name">Julio Landry</b>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <div class="label">Montant à envoyer</div>
        <div class="field">
          <input id="dep-amount-ariary" type="number" inputmode="decimal" placeholder="montant en ariary" />
          <span class="prefix">MGA</span>
        </div>
      </div>

      <div>
        <div class="label">Montant à recevoir</div>
        <div class="field">
          <input id="dep-amount-crypto" type="text" placeholder="0.00000000" readonly />
          <span class="suffix" id="dep-crypto-suffix">BTC</span>
        </div>
        <div class="note muted">
          <div id="dep-rate-note">1 BTC = … MGA</div>
          <div id="dep-fee-note">Frais: 0,3%</div>
        </div>
      </div>
    </div>

    <div class="crypto-strip" id="cryptoStripDepot">
      <h3>Destination : Choisir Crypto</h3>
      <!-- Rempli dynamiquement par JavaScript -->
    </div>
    <button class="expand-btn" id="expandCryptoDepot">
      <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      Plus de cryptos
    </button>

    <div class="ewallet-strip" id="ewalletStripDepot">
      <h3>Destination : Choisir E-wallet</h3>
      <!-- Rempli dynamiquement par JavaScript -->
    </div>

    <div class="label" style="margin-top:6px">Nom dans le compte</div>
    <div class="field"><input id="dep-holder" type="text" placeholder="Ex: Rakoto" /></div>

    <label class="checkbox">
      <input id="dep-accept" type="checkbox" />
      <span class="muted">Je certifie avoir lu et pris connaissance des conditions générales d'utilisation du site internet et les accepter sans réserve.</span>
    </label>
    <div class="actions">
      <button id="dep-preview" class="btn btn-primary" disabled>Aperçu</button>
      <span class="muted" id="dep-msg"></span>
    </div>
  </section>

  <!-- ================== RETRAIT ================== -->
  <section id="panel-retrait" class="panel" role="tabpanel" aria-labelledby="tab-retrait" hidden>
    <div class="crypto-strip" id="cryptoStripRetrait">
      <h3>Source : Choisir Crypto</h3>
      <!-- Rempli dynamiquement par JavaScript -->
    </div>
    <button class="expand-btn" id="expandCryptoRetrait">
      <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      Plus de cryptos
    </button>

    <div class="ewallet-strip" id="ewalletStripRetrait">
      <h3>Source : Choisir E-wallet</h3>
      <!-- Rempli dynamiquement par JavaScript -->
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <div class="label">Montant à envoyer</div>
        <div class="field">
          <input id="ret-amount-crypto" type="number" inputmode="decimal" placeholder="0.00000000" />
          <span class="suffix" id="ret-crypto-suffix">BTC</span>
        </div>
        <div class="note">
          <div class="row">
            <div class="field">
              <div class="label">Adresse (nô)</div>
              <input id="ret-our-addr" type="text" readonly />
            </div>
            <button id="ret-copy" class="btn btn-ghost">Copier</button>
          </div>
          <div class="muted" id="ret-crypto-only">Envoyer seulement en <b>BTC</b></div>
        </div>
      </div>

      <div>
        <div class="label">Montant à recevoir</div>
        <div class="field">
          <input id="ret-amount-ariary" type="text" placeholder="0 MGA" readonly />
          <span class="prefix">MGA</span>
          <span class="suffix" id="ret-wallet-logo">Mvola</span>
        </div>
        <div class="note muted">
          <div id="ret-rate-note">1 BTC = … MGA</div>
          <div id="ret-fee-note">Frais: 0,5%</div>
        </div>
      </div>
    </div>

    <div class="payment-destination">
      <h3>Destination : Mobile Money</h3>
      <div class="field">
        <input id="ret-phone" type="tel" placeholder="Numéro (mobile money / e-wallet)" />
        <span class="suffix" id="ret-wallet-icon">Mvola</span>
      </div>
      <div class="note muted" id="ret-wallet-note">Nom dans le compte Mvola</div>

      <div class="label">Nom du titulaire</div>
      <div class="field"><input id="ret-name" type="text" placeholder="Ex: Rakoto" /></div>
    </div>

    <label class="checkbox">
      <input id="ret-accept" type="checkbox" />
      <span class="muted">Je certifie avoir lu et pris connaissance des conditions générales d'utilisation du site internet et les accepter sans réserve.</span>
    </label>
    <div class="actions">
      <button id="ret-preview" class="btn btn-primary" disabled>Aperçu</button>
      <span class="muted" id="ret-msg"></span>
    </div>
  </section>

  <!-- ================== TRANSFERT ================== -->
  <section id="panel-transfert" class="panel" role="tabpanel" aria-labelledby="tab-transfert" hidden>
    <div class="crypto-strip" id="cryptoStripTransfert">
      <h3>Source : Choisir Crypto</h3>
      <!-- Rempli dynamiquement par JavaScript -->
    </div>
    <button class="expand-btn" id="expandCryptoTransfert">
      <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      Plus de cryptos
    </button>

    <div class="ewallet-strip" id="ewalletStripTransfert">
      <h3>Source : Choisir E-wallet</h3>
      <!-- Rempli dynamiquement par JavaScript -->
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <div class="label">Montant source</div>
        <div class="field">
          <input id="trf-amount-top" type="number" inputmode="decimal" placeholder="0.00000000" />
          <span class="suffix" id="trf-top-suffix">BTC</span>
        </div>
        <div class="note muted" id="trf-top-note">Crypto source: BTC</div>
      </div>

      <div>
        <div class="label">Montant destination</div>
        <div class="field">
          <input id="trf-amount-bot" type="text" placeholder="0.00000000" readonly />
          <span class="suffix" id="trf-bot-suffix">USDT</span>
        </div>
        <div class="note muted" id="trf-rate-note">1 BTC = 35 USDT</div>
      </div>
    </div>

    <div class="destination">
      <h3>Destination</h3>
      <div class="crypto-strip" id="cryptoStripTransfer"></div>
      <div class="ewallet-strip" id="ewalletStripTransfer"></div>

      <div class="label" style="margin-top:8px">Adresse de réception</div>
      <div class="field">
        <input id="trf-dest-addr" type="text" placeholder="Adresse de votre wallet" />
      </div>
    </div>

    <label class="checkbox">
      <input id="trf-accept" type="checkbox" />
      <span class="muted">Je certifie avoir lu et pris connaissance des conditions générales d'utilisation du site internet et les accepter sans réserve.</span>
    </label>
    <div class="actions">
      <button id="trf-preview" class="btn btn-primary" disabled>Aperçu</button>
      <span class="muted" id="trf-msg"></span>
    </div>
  </section>
</main>

<footer>
  <div class="footer-wrap">
    <div class="contact-title">Contact</div>
    <div class="cta">
      <div class="ctaitem" data-kind="email" id="cta-email" title="Email">
        <svg viewBox="0 0 24 24" fill="none"><path d="M4 6h16v12H4z" stroke="currentColor" stroke-width="2"/><path d="M4 7l8 6 8-6" stroke="currentColor" stroke-width="2"/></svg>
        Email
      </div>
      <div class="ctaitem" data-kind="call" id="cta-call" title="Téléphone">
        <svg viewBox="0 0 24 24" fill="none"><path d="M22 16.92v2a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.12 3.9 2 2 0 0 1 4.11 2h2a2 2 0 0 1 2 1.72c.12.9.3 1.78.57 2.63a2 2 0 0 1-.45 2.11L7.09 9.91a16 16 0 0 0 6 6l1.45-1.14a2 2 0 0 1 2.11-.45c.85.27 1.73.45 2.63.57A2 2 0 0 1 22 16.92z" stroke="currentColor" stroke-width="2"/></svg>
        Téléphone
      </div>
      <div class="ctaitem" data-kind="fb" id="cta-fb" title="Facebook">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 22v-8h3l1-4h-4V7c0-1.1.9-2 2-2h2V1h-3a5 5 0 0 0-5 5v4H6v4h3v8h4z"/></svg>
        Facebook
      </div>
      <div class="ctaitem" data-kind="wa" id="cta-wa" title="WhatsApp">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4.9A9.8 9.8 0 0 0 12.2 2C6.9 2 2.6 6.3 2.6 11.6c0 2 .6 3.9 1.8 5.5L3 22l4.9-1.3c1.5.8 3.2 1.2 4.9 1.2 5.3 0 9.6-4.3 9.6-9.6 0-2.6-1-5-2.7-6.8zM12.8 20c-1.5 0-2.9-.4-4.2-1.1l-.3-.2-2.9.8.8-2.8-.2-.3c-1-1.3-1.6-2.9-1.6-4.6C4.4 7.7 8 4.1 12.2 4.1c2.1 0 4.1.8 5.6 2.3 1.5 1.5 2.3 3.5 2.3 5.6 0 4.2-3.6 7.9-7.3 8z"/><path d="M16.6 13.7c-.2-.1-1.3-.7-1.5-.8-.2-.1-.4-.1-.5.1-.2.2-.6.8-.8 1-.1.1-.3.2-.5.1-.2-.1-.9-.3-1.7-1-.6-.6-1-1.2-1.1-1.4-.1-.2 0-.4.1-.5.1-.1.2-.3.3-.5.1-.1.1-.2.2-.4.1-.2 0-.3 0-.4s-.5-1.1-.7-1.5c-.2-.4-.4-.3-.5-.3h-.4c-.1 0-.4.1-.6.3-.2.2-.8.8-.8 2s.8 2.3.9 2.5c.1.2 1.6 2.6 3.8 3.6.5.2.9.4 1.2.5.5.2 1 .2 1.3.1.4-.1 1.3-.5 1.5-1 .2-.5.2-.9.1-1-.1-.1-.2-.1-.4-.2z"/></svg>
        WhatsApp
      </div>
    </div>

    <div class="legal">
      <a data-modal="cgu">Conditions générales d'utilisation</a>
      <a data-modal="mentions">Mentions légales</a>
      <a data-modal="privacy">Politique de confidentialité</a>
    </div>

    <div class="copy">© 2025 TakaloCash. Tous droits réservés.</div>
  </div>
</footer>

<!-- LEGAL MODALS -->
<dialog id="dlg-cgu"><h3>Conditions générales</h3><p>Exemple de conditions…</p><div style="text-align:right;margin-top:10px"><button onclick="this.closest('dialog').close()">OK</button></div></dialog>
<dialog id="dlg-mentions"><h3>Mentions légales</h3><p>Exemple de mentions…</p><div style="text-align:right;margin-top:10px"><button onclick="this.closest('dialog').close()">OK</button></div></dialog>
<dialog id="dlg-privacy"><h3>Politique de confidentialité</h3><p>Exemple de politique…</p><div style="text-align:right;margin-top:10px"><button onclick="this.closest('dialog').close()">OK</button></div></dialog>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
/* ================== CONFIG ================== */
const CONFIG = {
  // ---- API Configuration ----
  cryptoAPI: "https://api.coinpaprika.com/v1/tickers",
  
  // ---- Crypto Mapping for CoinPaprika ----
  cryptoMapping: {
    BTC: "btc-bitcoin",
    ETH: "eth-ethereum",
    USDT: "usdt-tether",
    LTC: "ltc-litecoin",
    BCH: "bch-bitcoin-cash",
    USDC: "usdc-usd-coin",
    BUSD: "busd-binance-usd",
    DAI: "dai-dai",
    ADA: "ada-cardano",
    SOL: "sol-solana",
    DOT: "dot-polkadot",
    LINK: "link-chainlink",
    UNI: "uni-uniswap",
    CAKE: "cake-pancakeswap"
  },

  // ---- Fallback Rates ----
  fallbackRates: {
    BTC: 150_000_000,
    ETH: 9_000_000,
    USDT: 4_500,
    LTC: 350_000,
    BCH: 2_800_000,
    USDC: 4_500,
    BUSD: 4_500,
    DAI: 4_500,
    ADA: 1_200,
    SOL: 700_000,
    DOT: 120_000,
    LINK: 80_000,
    UNI: 60_000,
    CAKE: 30_000
  },

  // ---- Fees ----
  fees: { 
    depot: 0.003, 
    retrait: 0.005, 
    transfert: 0.004 
  },
  cryptoFee: {
    depot: {
      BTC: 0.0005,
      ETH: 0.0015,
      USDT: 1
    },
    retrait: {
      BTC: 0.0003,
      ETH: 0.001,
      USDT: 0.5
    }
  },
  rateAdjustment: {
    depot: 0.96,
    retrait: 0.98
  },

  // ---- Existing Config ----
  emailjsPublicKey: "DEMO_PUBLIC_KEY_REPLACE_ME",
  emailjsServiceId: "DEMO_SERVICE_ID",
  emailjsTemplateId: "DEMO_TEMPLATE_ID",
  emailTo: "contact@takalocash.mg",
  phoneCall: "+261347451051",
  facebook: "https://facebook.com/",
  whatsapp: "https://wa.me/261347451051",
  
  wallets: {
    mvola: {label:"Mvola", num:"0347451051", name:"Julio Landry", logo:"Mvola"},
    orange: {label:"Orange Money", num:"0324923117", name:"Julio Landry", logo:"Orange"},
    airtel: {label:"Airtel Money", num:"0331483290", name:"Julio RANDRIANARIMANANA", logo:"Airtel"},
    wise: {label:"Wise", addr:"WISE-ACCOUNT-ID-EXEMPLE", name:"TakaloCash", logo:"$"},
    paypal: {label:"PayPal", addr:"paypal@takalocash.mg", name:"TakaloCash", logo:"$"},
    skrill: {label:"Skrill", addr:"skrill@takalocash.mg", name:"TakaloCash", logo:"€"},
    payoneer: {label:"Payoneer", addr:"PAYONEER-ID-EXEMPLE", name:"TakaloCash", logo:"$"}
  },
  
  cryptoAddrs: {
    BTC:"bc1-EXEMPLE-BTC-ADDRESS",
    ETH:"0xEXEMPLEETHADDRESS",
    LTC:"ltc1qEXEMPLE",
    BCH:"qzEXEMPLEBCH",
    USDT:"TEXEMPLEUSDT",
    USDC:"0xEXEMPLEUSDC",
    BUSD:"0xEXEMPLEBUSD",
    DAI:"0xEXEMPLEDAI",
    ADA:"addr1EXEMPLEADA",
    SOL:"SoLExemple1111",
    DOT:"dotEXEMPLE",
    LINK:"0xEXEMPLELINK",
    UNI:"0xEXEMPLEUNI",
    CAKE:"0xEXEMPLECAKE"
  },
  
  cryptosPrimary: ["BTC","ETH","USDT","LTC","BCH"],
  cryptosExtra: ["USDC","BUSD","DAI","ADA","SOL","DOT","LINK","UNI","CAKE"],
  ewalletsPrimary: ["wise","paypal","skrill","payoneer"]
};

/* ================== TRANSACTION SERVICE ================== */
class TransactionService {
  static async getAdjustedRate(service, cryptoSymbol) {
    try {
      const cryptoId = CONFIG.cryptoMapping[cryptoSymbol];
      if (!cryptoId) return CONFIG.fallbackRates[cryptoSymbol] || 0;
      
      const response = await fetch(`${CONFIG.cryptoAPI}/${cryptoId}`);
      if (!response.ok) throw new Error("API error");
      
      const data = await response.json();
      const marketRate = data?.quotes?.USD?.price || CONFIG.fallbackRates[cryptoSymbol];
      return marketRate * CONFIG.rateAdjustment[service];
    } catch (error) {
      console.error("Erreur taux:", error);
      return CONFIG.fallbackRates[cryptoSymbol] || 0;
    }
  }

  static async calculateDepot(amountAR, cryptoSymbol) {
    const rate = await this.getAdjustedRate('depot', cryptoSymbol);
    const networkFee = CONFIG.cryptoFee.depot[cryptoSymbol] || 0;
    const cryptoAmount = (amountAR / rate * (1 - CONFIG.fees.depot)) - networkFee;
    
    return {
      amount: Math.max(0, cryptoAmount).toFixed(8),
      rate: rate.toLocaleString(),
      fees: {
        service: CONFIG.fees.depot * 100,
        network: networkFee
      }
    };
  }

  static async calculateRetrait(amountCrypto, cryptoSymbol) {
    const rate = await this.getAdjustedRate('retrait', cryptoSymbol);
    const networkFee = CONFIG.cryptoFee.retrait[cryptoSymbol] || 0;
    const amountAR = ((amountCrypto - networkFee) * rate) * (1 - CONFIG.fees.retrait);
    
    return {
      amount: Math.max(0, amountAR).toLocaleString(),
      rate: rate.toLocaleString(),
      fees: {
        service: CONFIG.fees.retrait * 100,
        network: networkFee
      }
    };
  }
}

/* ================== UTILITY FUNCTIONS ================== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

function toast(msg, ms=2500){ 
  const t = $("#toast"); 
  t.textContent = msg; 
  t.classList.add("show"); 
  setTimeout(() => t.classList.remove("show"), ms); 
}

function rateLine(sym){ 
  const mg = CONFIG.ratesMGA[sym]; 
  return `1 ${sym} = ${mg ? mg.toLocaleString() : "—"} MGA`; 
}

function crossRate(a,b){ 
  const A = CONFIG.ratesMGA[a]; 
  const B = CONFIG.ratesMGA[b]; 
  return (A && B) ? +(A/B).toFixed(8) : "—"; 
}

const applyFee = (x,f) => x*(1-f);

/* ================== GLOBAL STATE ================== */
let currentLang = "fr";
let currentCrypto = "BTC";
let transferTarget = "USDT";
let payChoice = "mvola";

/* ================== UI FUNCTIONS ================== */
function createCryptoElement(symbol, active = false, onClick = null) {
  const div = document.createElement("div");
  div.className = "crypto";
  div.textContent = symbol;
  if (active) div.style.backgroundColor = "var(--brand)";
  if (onClick) div.addEventListener("click", onClick);
  return div;
}

function createEwalletElement(key, label, active = false, onClick = null) {
  const div = document.createElement("div");
  div.className = "crypto";
  div.textContent = label;
  if (active) div.style.backgroundColor = "var(--brand)";
  if (onClick) div.addEventListener("click", () => onClick(key));
  return div;
}

function renderStrips() {
  // Depot Crypto Strip
  const depotCryptoStrip = $("#cryptoStripDepot");
  depotCryptoStrip.innerHTML = "<h3>Destination : Choisir Crypto</h3>";
  CONFIG.cryptosPrimary.forEach(sym => {
    depotCryptoStrip.appendChild(createCryptoElement(sym, sym === currentCrypto, () => {
      currentCrypto = sym;
      refreshDepot();
    }));
  });

  // Depot E-wallet Strip
  const depotEwalletStrip = $("#ewalletStripDepot");
  depotEwalletStrip.innerHTML = "<h3>Destination : Choisir E-wallet</h3>";
  CONFIG.ewalletsPrimary.forEach(k => {
    const lab = CONFIG.wallets[k].label;
    depotEwalletStrip.appendChild(createEwalletElement(k, lab, k === payChoice, (key) => {
      payChoice = key;
      refreshDepot();
    }));
  });

  // Retrait Crypto Strip
  const retraitCryptoStrip = $("#cryptoStripRetrait");
  retraitCryptoStrip.innerHTML = "<h3>Source : Choisir Crypto</h3>";
  CONFIG.cryptosPrimary.forEach(sym => {
    retraitCryptoStrip.appendChild(createCryptoElement(sym, sym === currentCrypto, () => {
      currentCrypto = sym;
      refreshRetrait();
    }));
  });

  // Transfert Crypto Strip
  const transfertCryptoStrip = $("#cryptoStripTransfert");
  transfertCryptoStrip.innerHTML = "<h3>Source : Choisir Crypto</h3>";
  CONFIG.cryptosPrimary.forEach(sym => {
    transfertCryptoStrip.appendChild(createCryptoElement(sym, sym === currentCrypto, () => {
      currentCrypto = sym;
      refreshTransfer();
    }));
  });

  // Transfert Destination Strips
  const cryptoDestStrip = $("#cryptoStripTransfer");
  cryptoDestStrip.innerHTML = "";
  CONFIG.cryptosPrimary.forEach(sym => {
    cryptoDestStrip.appendChild(createCryptoElement(sym, sym === transferTarget, () => {
      transferTarget = sym;
      refreshTransfer();
    }));
  });

  const ewalletDestStrip = $("#ewalletStripTransfer");
  ewalletDestStrip.innerHTML = "";
  CONFIG.ewalletsPrimary.forEach(k => {
    const lab = CONFIG.wallets[k].label;
    ewalletDestStrip.appendChild(createEwalletElement(k, lab, k === transferTarget, (key) => {
      transferTarget = key;
      refreshTransfer();
    }));
  });
}

/* ================== EXPAND BUTTONS ================== */
$("#expandCryptoDepot").addEventListener("click", () => {
  const strip = $("#cryptoStripDepot");
  CONFIG.cryptosExtra.forEach(sym => {
    strip.appendChild(createCryptoElement(sym, sym === currentCrypto, () => {
      currentCrypto = sym;
      refreshDepot();
    }));
  });
  $("#expandCryptoDepot").style.display = "none";
});

$("#expandCryptoRetrait").addEventListener("click", () => {
  const strip = $("#cryptoStripRetrait");
  CONFIG.cryptosExtra.forEach(sym => {
    strip.appendChild(createCryptoElement(sym, sym === currentCrypto, () => {
      currentCrypto = sym;
      refreshRetrait();
    }));
  });
  $("#expandCryptoRetrait").style.display = "none";
});

$("#expandCryptoTransfert").addEventListener("click", () => {
  const strip = $("#cryptoStripTransfert");
  CONFIG.cryptosExtra.forEach(sym => {
    strip.appendChild(createCryptoElement(sym, sym === currentCrypto, () => {
      currentCrypto = sym;
      refreshTransfer();
    }));
  });
  $("#expandCryptoTransfert").style.display = "none";
});

/* ================== REFRESH FUNCTIONS ================== */
async function refreshDepot() {
  const mga = +($("#dep-amount-ariary").value || 0);
  
  if (mga > 0) {
    try {
      const result = await TransactionService.calculateDepot(mga, currentCrypto);
      $("#dep-amount-crypto").value = result.amount;
      $("#dep-crypto-suffix").textContent = currentCrypto;
      $("#dep-rate-note").textContent = `1 ${currentCrypto} = ${result.rate} USD (Taux ajusté)`;
      $("#dep-fee-note").textContent = `Frais: ${result.fees.service}% service + ${result.fees.network} ${currentCrypto} réseau`;
    } catch (e) {
      console.error("Erreur calcul dépôt:", e);
      $("#dep-amount-crypto").value = "";
      $("#dep-rate-note").textContent = "Erreur de calcul";
    }
  } else {
    $("#dep-amount-crypto").value = "";
  }
  
  updateDepotDest();
  renderStrips();
}

async function refreshRetrait() {
  const qty = +($("#ret-amount-crypto").value || 0);
  
  if (qty > 0) {
    try {
      const result = await TransactionService.calculateRetrait(qty, currentCrypto);
      $("#ret-amount-ariary").value = result.amount;
      $("#ret-rate-note").textContent = `1 ${currentCrypto} = ${result.rate} USD (Taux ajusté)`;
      $("#ret-fee-note").textContent = `Frais: ${result.fees.service}% service + ${result.fees.network} ${currentCrypto} réseau`;
    } catch (e) {
      console.error("Erreur calcul retrait:", e);
      $("#ret-amount-ariary").value = "";
      $("#ret-rate-note").textContent = "Erreur de calcul";
    }
  } else {
    $("#ret-amount-ariary").value = "";
  }
  
  $("#ret-crypto-suffix").textContent = currentCrypto;
  $("#ret-our-addr").value = CONFIG.cryptoAddrs[currentCrypto] || "";
  $("#ret-crypto-only").innerHTML = `Envoyer seulement en <b>${currentCrypto}</b>`;
  renderStrips();
}

function refreshTransfer() {
  const qty = +($("#trf-amount-top").value || 0);
  const isTargetCrypto = /^[A-Z]{3,5}$/.test(transferTarget);
  let rate = "—", out = 0;
  
  if(isTargetCrypto){
    rate = crossRate(currentCrypto, transferTarget);
    out = applyFee(qty * (Number(rate)||0, CONFIG.fees.transfert);
  } else {
    rate = crossRate(currentCrypto, "USDT");
    out = applyFee(qty * (Number(rate)||0, CONFIG.fees.transfert);
  }
  
  $("#trf-amount-bot").value = out ? out.toFixed(8) : "";
  $("#trf-top-suffix").textContent = currentCrypto;
  $("#trf-bot-suffix").textContent = isTargetCrypto ? transferTarget : transferTarget.toUpperCase();
  $("#trf-top-note").textContent = `Crypto source: ${currentCrypto}`;
  $("#trf-rate-note").textContent = `1 ${currentCrypto} = ${rate} ${isTargetCrypto ? transferTarget : "USDT"}`;
  
  renderStrips();
}

function updateDepotDest() {
  const isMobile = ["mvola","orange","airtel"].includes(payChoice);
  const isEwallet = Object.keys(CONFIG.wallets).includes(payChoice) && !isMobile;
  const isCrypto = !!CONFIG.cryptoAddrs[payChoice] || !!CONFIG.cryptoAddrs[currentCrypto];

  if(isMobile){
    const w = CONFIG.wallets[payChoice];
    $("#dep-pay-dest").textContent = w.num;
    $("#dep-pay-name").textContent = w.name;
    $("#dep-addr").value = w.num;
    $("#dep-addr-label").textContent = "Numéro de paiement";
    $("#dep-addr-note").textContent = "Numéro présaisi (non modifiable).";
  } else if(isEwallet){
    const w = CONFIG.wallets[payChoice];
    $("#dep-pay-dest").textContent = w.addr || w.num || "";
    $("#dep-pay-name").textContent = w.name || "TakaloCash";
    $("#dep-addr").value = w.addr || "";
    $("#dep-addr-label").textContent = "Adresse de paiement";
    $("#dep-addr-note").textContent = "Adresse/identifiant présaisie selon le moyen sélectionné (non modifiable).";
  } else if(isCrypto){
    const sym = /[A-Z]{3,5}/.test(payChoice) ? payChoice : currentCrypto;
    const addr = CONFIG.cryptoAddrs[sym] || "";
    $("#dep-pay-dest").textContent = addr.slice(0,10)+"…";
    $("#dep-pay-name").textContent = "TakaloCash";
    $("#dep-addr").value = addr;
    $("#dep-addr-label").textContent = "Adresse de paiement";
    $("#dep-addr-note").textContent = "Adresse crypto présaisie (non modifiable).";
  } else {
    $("#dep-pay-dest").textContent = "";
    $("#dep-pay-name").textContent = "";
    $("#dep-addr").value = "";
  }
}

/* ================== INITIALIZATION ================== */
renderStrips();
updateDepotDest();
refreshAll();

// [LE RESTE DE VOTRE CODE EXISTANT...]
</script>
</body>
</html>
