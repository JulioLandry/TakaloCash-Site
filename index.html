<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TakaloCash – Service</title>
<style>
  /* [VOTRE CSS EXISTANT RESTE IDENTIQUE] */
  :root{
    --brand:#ffbf00;        /* volamena */
    --brand-2:#d9a300;
    --dark:#0c0c0c;
    --ink:#222;
    --muted:#6d6d6d;
    --grey:#f5f5f5;
    --ok:#16a34a;
    --danger:#dc2626;
    --pill:999px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
  /* ... [TOUT LE RESTE DE VOTRE CSS] ... */
</style>
</head>
<body>

<!-- [VOTRE HTML EXISTANT RESTE IDENTIQUE] -->
<header>
  <div class="topbar">
    <!-- ... -->
  </div>
</header>

<main>
  <!-- ... -->
</main>

<footer>
  <!-- ... -->
</footer>

<!-- MODALES ET TOAST (inchangés) -->
<dialog id="dlg-cgu"><!-- ... --></dialog>
<dialog id="dlg-mentions"><!-- ... --></dialog>
<dialog id="dlg-privacy"><!-- ... --></dialog>
<div class="toast" id="toast"></div>

<script>
/* ================== CONFIG AVEC COINPAPRIKA ================== */
const CONFIG = {
  // Configuration API
  cryptoAPI: "https://api.coinpaprika.com/v1/tickers",
  
  // Mapping des cryptos pour CoinPaprika
  cryptoMapping: {
    BTC: "btc-bitcoin",
    ETH: "eth-ethereum",
    USDT: "usdt-tether",
    LTC: "ltc-litecoin",
    BCH: "bch-bitcoin-cash",
    USDC: "usdc-usd-coin",
    BUSD: "busd-binance-usd",
    DAI: "dai-dai",
    ADA: "ada-cardano",
    SOL: "sol-solana",
    DOT: "dot-polkadot",
    LINK: "link-chainlink",
    UNI: "uni-uniswap",
    CAKE: "cake-pancakeswap"
  },

  // Taux de repli (si API indisponible)
  fallbackRates: {
    BTC: 150_000_000, 
    ETH: 9_000_000,
    USDT: 4_500,
    LTC: 350_000,
    BCH: 2_800_000,
    USDC: 4_500,
    BUSD: 4_500,
    DAI: 4_500,
    ADA: 1_200,
    SOL: 700_000,
    DOT: 120_000,
    LINK: 80_000,
    UNI: 60_000,
    CAKE: 30_000
  },

  // Frais et ajustements
  fees: { 
    depot: 0.003, 
    retrait: 0.005, 
    transfert: 0.004 
  },
  cryptoFee: {
    depot: {
      BTC: 0.0005,
      ETH: 0.0015,
      USDT: 1
    },
    retrait: {
      BTC: 0.0003,
      ETH: 0.001,
      USDT: 0.5
    }
  },
  rateAdjustment: {
    depot: 0.96,
    retrait: 0.98
  },

  // Configuration existante
  emailjsPublicKey: "DEMO_PUBLIC_KEY_REPLACE_ME",
  emailjsServiceId: "DEMO_SERVICE_ID",
  emailjsTemplateId: "DEMO_TEMPLATE_ID",
  emailTo: "contact@takalocash.mg",
  phoneCall: "+261347451051",
  facebook: "https://facebook.com/",
  whatsapp: "https://wa.me/261347451051",
  
  wallets: {
    mvola: {label:"Mvola", num:"0347451051", name:"Julio Landry", logo:"Mvola"},
    orange: {label:"Orange Money", num:"0324923117", name:"Julio Landry", logo:"Orange"},
    airtel: {label:"Airtel Money", num:"0331483290", name:"Julio RANDRIANARIMANANA", logo:"Airtel"},
    wise: {label:"Wise", addr:"WISE-ACCOUNT-ID-EXEMPLE", name:"TakaloCash", logo:"$"},
    paypal: {label:"PayPal", addr:"paypal@takalocash.mg", name:"TakaloCash", logo:"$"},
    skrill: {label:"Skrill", addr:"skrill@takalocash.mg", name:"TakaloCash", logo:"€"},
    payoneer: {label:"Payoneer", addr:"PAYONEER-ID-EXEMPLE", name:"TakaloCash", logo:"$"}
  },
  
  cryptoAddrs: {
    BTC:"bc1-EXEMPLE-BTC-ADDRESS",
    ETH:"0xEXEMPLEETHADDRESS",
    LTC:"ltc1qEXEMPLE",
    BCH:"qzEXEMPLEBCH",
    USDT:"TEXEMPLEUSDT",
    USDC:"0xEXEMPLEUSDC",
    BUSD:"0xEXEMPLEBUSD",
    DAI:"0xEXEMPLEDAI",
    ADA:"addr1EXEMPLEADA",
    SOL:"SoLExemple1111",
    DOT:"dotEXEMPLE",
    LINK:"0xEXEMPLELINK",
    UNI:"0xEXEMPLEUNI",
    CAKE:"0xEXEMPLECAKE"
  },
  
  cryptosPrimary: ["BTC","ETH","USDT","LTC","BCH"],
  cryptosExtra: ["USDC","BUSD","DAI","ADA","SOL","DOT","LINK","UNI","CAKE"],
  ewalletsPrimary: ["wise","paypal","skrill","payoneer"]
};

/* ================== SERVICE DE TRANSACTION ================== */
class TransactionService {
  static async getAdjustedRate(service, cryptoSymbol) {
    try {
      const cryptoId = CONFIG.cryptoMapping[cryptoSymbol];
      if (!cryptoId) return CONFIG.fallbackRates[cryptoSymbol] || 0;
      
      const response = await fetch(`${CONFIG.cryptoAPI}/${cryptoId}`);
      if (!response.ok) throw new Error("API error");
      
      const data = await response.json();
      const marketRate = data?.quotes?.USD?.price || CONFIG.fallbackRates[cryptoSymbol];
      return marketRate * CONFIG.rateAdjustment[service];
    } catch (error) {
      console.error("Erreur taux:", error);
      return CONFIG.fallbackRates[cryptoSymbol] || 0;
    }
  }

  static async calculateDepot(amountAR, cryptoSymbol) {
    const rate = await this.getAdjustedRate('depot', cryptoSymbol);
    const networkFee = CONFIG.cryptoFee.depot[cryptoSymbol] || 0;
    const cryptoAmount = (amountAR / rate * (1 - CONFIG.fees.depot)) - networkFee;
    
    return {
      amount: Math.max(0, cryptoAmount).toFixed(8),
      rate: rate.toLocaleString(),
      fees: {
        service: CONFIG.fees.depot * 100,
        network: networkFee
      }
    };
  }

  static async calculateRetrait(amountCrypto, cryptoSymbol) {
    const rate = await this.getAdjustedRate('retrait', cryptoSymbol);
    const networkFee = CONFIG.cryptoFee.retrait[cryptoSymbol] || 0;
    const amountAR = ((amountCrypto - networkFee) * rate) * (1 - CONFIG.fees.retrait);
    
    return {
      amount: Math.max(0, amountAR).toLocaleString(),
      rate: rate.toLocaleString(),
      fees: {
        service: CONFIG.fees.retrait * 100,
        network: networkFee
      }
    };
  }
}

/* ================== INITIALISATION ================== */
(function(){
  if(window.emailjs){
    try{ emailjs.init({publicKey: CONFIG.emailjsPublicKey}); }catch(e){}
  }
})();

/* ================== FONCTIONS UTILITAIRES ================== */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

function toast(msg, ms=2500){ 
  const t = $("#toast"); 
  t.textContent = msg; 
  t.classList.add("show"); 
  setTimeout(() => t.classList.remove("show"), ms); 
}

function rateLine(sym){ 
  const mg = CONFIG.ratesMGA[sym]; 
  return `1 ${sym} = ${mg ? mg.toLocaleString() : "—"} MGA`; 
}

function crossRate(a,b){ 
  const A = CONFIG.ratesMGA[a]; 
  const B = CONFIG.ratesMGA[b]; 
  return (A && B) ? +(A/B).toFixed(8) : "—"; 
}

const applyFee = (x,f) => x*(1-f);

/* ================== ETAT GLOBAL ================== */
let currentLang = "fr";
let currentCrypto = "BTC";
let transferTarget = "USDT";
let payChoice = "mvola";
let showMoreCryptos = false, showMoreEwallets = false;
let showMoreCryptos2 = false, showMoreEwallets2 = false;
let showMoreCryptos3 = false, showMoreEwallets3 = false;

/* ================== FONCTIONS D'INTERFACE ================== */
function chip(label, active, onClick){
  const b = document.createElement("button");
  b.className = "chip"; 
  b.textContent = label; 
  b.setAttribute("aria-pressed", active ? "true" : "false");
  b.addEventListener("click", onClick); 
  return b;
}

function ewbtn(key, label, active, onClick){
  const b = document.createElement("button");
  b.className = "ewbtn"; 
  b.textContent = label; 
  b.setAttribute("aria-pressed", active ? "true" : "false");
  b.dataset.key = key; 
  b.addEventListener("click", onClick); 
  return b;
}

function renderStrips(){
  // Crypto strip principale
  const strip = $("#cryptoStrip"); 
  strip.innerHTML = "";
  [...CONFIG.cryptosPrimary, ...(showMoreCryptos ? CONFIG.cryptosExtra : [])].forEach(sym => {
    strip.appendChild(chip(sym, sym === currentCrypto, () => { 
      currentCrypto = sym; 
      if(payChoice in CONFIG.wallets || CONFIG.cryptoAddrs[payChoice]){/* keep */} 
      refreshAll(); 
    }));
  });
  
  // E-wallet strip
  const ew = $("#ewalletStrip"); 
  ew.innerHTML = "";
  [...CONFIG.ewalletsPrimary, ...(showMoreEwallets ? [] : [])].forEach(k => {
    const lab = CONFIG.wallets[k].label; 
    ew.appendChild(ewbtn(k, lab, k === payChoice, () => { 
      payChoice = k; 
      refreshAll(); 
    }));
  });
  
  // Strips pour les transferts
  const stripT = $("#cryptoStripTransfer"); 
  if(stripT){ 
    stripT.innerHTML = "";
    [...CONFIG.cryptosPrimary, ...(showMoreCryptos3 ? CONFIG.cryptosExtra : [])].forEach(sym => {
      stripT.appendChild(chip(sym, sym === transferTarget, () => { 
        transferTarget = sym; 
        refreshTransfer(); 
      }));
    });
  }
  
  const ewT = $("#ewalletStripTransfer"); 
  if(ewT){ 
    ewT.innerHTML = "";
    CONFIG.ewalletsPrimary.forEach(k => {
      const lab = CONFIG.wallets[k].label; 
      ewT.appendChild(ewbtn(k, lab, k === transferTarget, () => { 
        transferTarget = k; 
        refreshTransfer(); 
      }));
    });
  }
}

function toggleBtn(el, open){
  el.innerHTML = open
    ? `<svg viewBox="0 0 24 24" fill="none"><path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Réduire`
    : `<svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Plus`;
}

function updateDepotDest(){
  const isMobile = ["mvola","orange","airtel"].includes(payChoice);
  const isEwallet = Object.keys(CONFIG.wallets).includes(payChoice) && !isMobile;
  const isCrypto = !!CONFIG.cryptoAddrs[payChoice] || !!CONFIG.cryptoAddrs[currentCrypto];

  if(isMobile){
    const w = CONFIG.wallets[payChoice];
    $("#dep-pay-dest").textContent = w.num;
    $("#dep-pay-name").textContent = w.name;
    $("#dep-pay-logo").textContent = w.logo;
    $("#dep-addr").value = w.num;
    $("#dep-addr-label").textContent = "Numéro de paiement";
    $("#dep-addr-note").textContent = "Numéro présaisi (non modifiable).";
  } else if(isEwallet){
    const w = CONFIG.wallets[payChoice];
    $("#dep-pay-dest").textContent = w.addr || w.num || "";
    $("#dep-pay-name").textContent = w.name || "TakaloCash";
    $("#dep-pay-logo").textContent = w.logo;
    $("#dep-addr").value = w.addr || "";
    $("#dep-addr-label").textContent = "Adresse de paiement";
    $("#dep-addr-note").textContent = "Adresse/identifiant présaisie selon le moyen sélectionné (non modifiable).";
  } else if(isCrypto){
    const sym = /[A-Z]{3,5}/.test(payChoice) ? payChoice : currentCrypto;
    const addr = CONFIG.cryptoAddrs[sym] || "";
    $("#dep-pay-dest").textContent = addr.slice(0,10)+"…";
    $("#dep-pay-name").textContent = "TakaloCash";
    $("#dep-pay-logo").textContent = sym;
    $("#dep-addr").value = addr;
    $("#dep-addr-label").textContent = "Adresse de paiement";
    $("#dep-addr-note").textContent = "Adresse crypto présaisie (non modifiable).";
  } else {
    $("#dep-pay-dest").textContent = "";
    $("#dep-pay-name").textContent = "";
    $("#dep-addr").value = "";
  }
}

/* ================== FONCTIONS DE RAFRAICHISSEMENT ================== */
async function refreshDepot(){
  const mga = +($("#dep-amount-ariary").value || 0);
  
  if (mga > 0) {
    try {
      const result = await TransactionService.calculateDepot(mga, currentCrypto);
      $("#dep-amount-crypto").value = result.amount;
      $("#dep-crypto-suffix").textContent = currentCrypto;
      $("#dep-rate-note").textContent = `1 ${currentCrypto} = ${result.rate} USD (Taux ajusté)`;
      $("#dep-fee-note").textContent = `Frais: ${result.fees.service}% service + ${result.fees.network} ${currentCrypto} réseau`;
    } catch (e) {
      console.error("Erreur calcul dépôt:", e);
      $("#dep-amount-crypto").value = "";
      $("#dep-rate-note").textContent = "Erreur de calcul";
    }
  } else {
    $("#dep-amount-crypto").value = "";
  }
  
  updateDepotDest();
}

async function refreshRetrait(){
  const qty = +($("#ret-amount-crypto").value || 0);
  
  if (qty > 0) {
    try {
      const result = await TransactionService.calculateRetrait(qty, currentCrypto);
      $("#ret-amount-ariary").value = result.amount;
      $("#ret-rate-note").textContent = `1 ${currentCrypto} = ${result.rate} USD (Taux ajusté)`;
      $("#ret-fee-note").textContent = `Frais: ${result.fees.service}% service + ${result.fees.network} ${currentCrypto} réseau`;
    } catch (e) {
      console.error("Erreur calcul retrait:", e);
      $("#ret-amount-ariary").value = "";
      $("#ret-rate-note").textContent = "Erreur de calcul";
    }
  } else {
    $("#ret-amount-ariary").value = "";
  }
  
  $("#ret-crypto-suffix").textContent = currentCrypto;
  $("#ret-our-addr").value = CONFIG.cryptoAddrs[currentCrypto] || "";
  $("#ret-crypto-only").innerHTML = `Envoyer seulement en <b>${currentCrypto}</b>`;
}

function refreshTransfer(){
  const qty = +($("#trf-amount-top").value || 0);
  const isTargetCrypto = /^[A-Z]{3,5}$/.test(transferTarget);
  let rate = "—", out = 0;
  
  if(isTargetCrypto){
    rate = crossRate(currentCrypto, transferTarget);
    out = applyFee(qty * (Number(rate)||0), CONFIG.fees.transfert);
  } else {
    rate = crossRate(currentCrypto, "USDT");
    out = applyFee(qty * (Number(rate)||0), CONFIG.fees.transfert);
  }
  
  $("#trf-amount-bot").value = out ? out.toFixed(8) : "";
  $("#trf-top-suffix").textContent = currentCrypto;
  $("#trf-bot-suffix").textContent = isTargetCrypto ? transferTarget : transferTarget.toUpperCase();
  $("#trf-top-note").textContent = `Crypto source: ${currentCrypto}`;
  $("#trf-rate-note").textContent = `1 ${currentCrypto} = ${rate} ${isTargetCrypto ? transferTarget : "USDT"}`;
  
  $$("#cryptoStrip .chip").forEach(b => b.setAttribute("aria-pressed", b.textContent === currentCrypto ? "true" : "false"));
  $$("#cryptoStripTransfer .chip").forEach(b => b.setAttribute("aria-pressed", b.textContent === transferTarget ? "true" : "false"));
  $$("#ewalletStripTransfer .ewbtn").forEach(b => b.setAttribute("aria-pressed", b.dataset.key === transferTarget ? "true" : "false"));
}

function refreshAll(){ 
  renderStrips(); 
  refreshDepot(); 
  refreshRetrait(); 
  refreshTransfer(); 
}

/* ================== GESTION DES EVENEMENTS ================== */
// Expand buttons
$("#toggleMoreCryptos").addEventListener("click", () => { 
  showMoreCryptos = !showMoreCryptos; 
  renderStrips(); 
  toggleBtn($("#toggleMoreCryptos"), showMoreCryptos); 
});

$("#toggleMoreEwallets").addEventListener("click", () => { 
  showMoreEwallets = !showMoreEwallets; 
  renderStrips(); 
  toggleBtn($("#toggleMoreEwallets"), showMoreEwallets); 
});

$("#toggleMoreCryptos2").addEventListener("click", () => { 
  showMoreCryptos2 = !showMoreCryptos2; 
  showMoreCryptos = showMoreCryptos2; 
  renderStrips(); 
  toggleBtn($("#toggleMoreCryptos2"), showMoreCryptos2); 
});

$("#toggleMoreEwallets2").addEventListener("click", () => { 
  showMoreEwallets2 = !showMoreEwallets2; 
  showMoreEwallets = showMoreEwallets2; 
  renderStrips(); 
  toggleBtn($("#toggleMoreEwallets2"), showMoreEwallets2); 
});

$("#toggleMoreCryptos3").addEventListener("click", () => { 
  showMoreCryptos3 = !showMoreCryptos3; 
  renderStrips(); 
  toggleBtn($("#toggleMoreCryptos3"), showMoreCryptos3); 
});

$("#toggleMoreEwallets3").addEventListener("click", () => { 
  showMoreEwallets3 = !showMoreEwallets3; 
  renderStrips(); 
  toggleBtn($("#toggleMoreEwallets3"), showMoreEwallets3); 
});

// Tabs
$$(".tab").forEach(t => {
  t.addEventListener("click", () => {
    $$(".tab").forEach(x => x.setAttribute("aria-selected", "false"));
    t.setAttribute("aria-selected", "true");
    const tab = t.dataset.tab;
    $("#panel-depot").hidden = tab !== "depot";
    $("#panel-retrait").hidden = tab !== "retrait";
    $("#panel-transfert").hidden = tab !== "transfert";
    refreshAll();
  });
});

// Payment options
$("#dep-pay-opts").addEventListener("click", e => {
  const btn = e.target.closest(".paybtn"); 
  if(!btn) return;
  payChoice = btn.dataset.pay;
  $$("#dep-pay-opts .paybtn").forEach(b => b.setAttribute("aria-pressed", b.dataset.pay === payChoice ? "true" : "false"));
  updateDepotDest();
});

// Checkboxes
["dep","ret","trf"].forEach(k => {
  $(`#${k}-accept`).addEventListener("change", () => { 
    $(`#${k}-preview`).disabled = !$(`#${k}-accept`).checked; 
  });
});

// Copy buttons
$("#dep-copy").addEventListener("click", () => { 
  const el = $("#dep-addr"); 
  el.select(); 
  document.execCommand("copy"); 
  toast("Copié !"); 
});

$("#ret-copy").addEventListener("click", () => { 
  $("#ret-our-addr").select(); 
  document.execCommand("copy"); 
  toast("Copié !"); 
});

// Inputs
$("#dep-amount-ariary").addEventListener("input", refreshDepot);
$("#ret-amount-crypto").addEventListener("input", refreshRetrait);
$("#ret-phone").addEventListener("input", function(){
  const num = this.value.trim();
  let wallet = "mvola";
  if(num.startsWith("032") || num.startsWith("037")) wallet = "orange";
  else if(num.startsWith("033")) wallet = "orange";
  $("#ret-wallet-icon").textContent = CONFIG.wallets[wallet]?.logo || "";
});
$("#trf-amount-top").addEventListener("input", refreshTransfer);

// Langues
$("#lang-fr").addEventListener("click", () => { setLang("fr"); });
$("#lang-mg").addEventListener("click", () => { setLang("mg"); });

function setLang(l){
  currentLang = l;
  $("#lang-fr").classList.toggle("lang-active", l === "fr");
  $("#lang-mg").classList.toggle("lang-active", l === "mg");
}

// Footer CTAs
$("#cta-email").addEventListener("click", () => window.location.href = `mailto:${CONFIG.emailTo}`);
$("#cta-call").addEventListener("click", () => window.location.href = `tel:${CONFIG.phoneCall}`);
$("#cta-fb").addEventListener("click", () => window.open(CONFIG.facebook, "_blank"));
$("#cta-wa").addEventListener("click", () => window.open(CONFIG.whatsapp, "_blank"));
$$(".legal a").forEach(a => a.addEventListener("click", () => $(`#dlg-${a.dataset.modal}`).showModal()));

/* ================== VALIDATION ET ENVOI ================== */
function requiredFilledDepot(){
  const a = $("#dep-amount-ariary").value.trim() !== "" && Number($("#dep-amount-ariary").value) > 0;
  const addr = $("#dep-addr").value.trim() !== "";
  const holder = $("#dep-holder").value.trim() !== "";
  const chk = $("#dep-accept").checked;
  return a && addr && holder && chk;
}

function requiredFilledRetrait(){
  const q = $("#ret-amount-crypto").value.trim() !== "" && Number($("#ret-amount-crypto").value) > 0;
  const our = $("#ret-our-addr").value.trim() !== "";
  const phone = $("#ret-phone").value.trim() !== "";
  const name = $("#ret-name").value.trim() !== "";
  const chk = $("#ret-accept").checked;
  return q && our && phone && name && chk;
}

function requiredFilledTransfert(){
  const q = $("#trf-amount-top").value.trim() !== "" && Number($("#trf-amount-top").value) > 0;
  const addr = $("#trf-dest-addr").value.trim() !== "";
  const chk = $("#trf-accept").checked;
  return q && addr && chk;
}

function guardOrWarn(ok){ 
  if(!ok){ 
    toast("Fenoy avokoa ny saha rehetra ary cocheo ny fepetra."); 
  } 
  return ok; 
}

// Preview handlers
$("#dep-preview").addEventListener("click", async () => {
  if(!guardOrWarn(requiredFilledDepot())) return;
  if(!confirm("Hamarino tsara ny fampidiranao. Hanohy handefa?")) return;
  const payload = {
    service: "DEPOT",
    crypto: currentCrypto,
    pay_choice: payChoice,
    montant_ariary: $("#dep-amount-ariary").value,
    montant_crypto: $("#dep-amount-crypto").value,
    adresse_paiement: $("#dep-addr").value,
    nom_dans_compte: $("#dep-holder").value,
    taux: rateLine(currentCrypto),
    frais: (CONFIG.fees.depot*100).toFixed(1)+"%"
  };
  await sendEmail(payload);
});

$("#ret-preview").addEventListener("click", async () => {
  if(!guardOrWarn(requiredFilledRetrait())) return;
  if(!confirm("Hamarino tsara ny fampidiranao. Hanohy handefa?")) return;
  const payload = {
    service: "RETRAIT",
    crypto: currentCrypto,
    montant_crypto: $("#ret-amount-crypto").value,
    adresse_nou: $("#ret-our-addr").value,
    montant_mga: $("#ret-amount-ariary").value,
    wallet: $("#ret-wallet").value,
    telephone: $("#ret-phone").value,
    nom_dans_compte: $("#ret-name").value,
    taux: rateLine(currentCrypto),
    frais: (CONFIG.fees.retrait*100).toFixed(1)+"%"
  };
  await sendEmail(payload);
});

$("#trf-preview").addEventListener("click", async () => {
  if(!guardOrWarn(requiredFilledTransfert())) return;
  if(!confirm("Hamarino tsara ny fampidiranao. Hanohy handefa?")) return;
  const payload = {
    service: "TRANSFERT",
    crypto_source: currentCrypto,
    montant_source: $("#trf-amount-top").value,
    target: transferTarget,
    montant_cible: $("#trf-amount-bot").value,
    adresse_dest: $("#trf-dest-addr").value,
    taux: `1 ${currentCrypto} = ${crossRate(currentCrypto, /^[A-Z]{3,5}$/.test(transferTarget)?transferTarget:"USDT")} ${/^[A-Z]{3,5}$/.test(transferTarget)?transferTarget:"USDT"}`,
    frais: (CONFIG.fees.transfert*100).toFixed(1)+"%"
  };
  await sendEmail(payload);
});

async function sendEmail(data){
  const okConfig = CONFIG.emailjsPublicKey !== "DEMO_PUBLIC_KEY_REPLACE_ME" && 
                   CONFIG.emailjsServiceId !== "DEMO_SERVICE_ID" && 
                   CONFIG.emailjsTemplateId !== "DEMO_TEMPLATE_ID";
  try {
    if(okConfig && window.emailjs){
      await emailjs.send(CONFIG.emailjsServiceId, CONFIG.emailjsTemplateId, data);
      toast("Votre demande a été reçue. Veuillez envoyer le montant sous 15 minutes, sinon la demande sera annulée.");
    } else {
      console.log("DEMO SEND ->", data);
      toast("SUCCESS (DEMO): Demande enregistrée. Envoyez le montant sous 15 minutes.");
    }
  } catch(e) {
    console.error(e);
    toast("Erreur lors de l'envoi. Hamarino ny connexion na ny configuration EmailJS.", 3500);
  }
}

/* ================== INITIALISATION FINALE ================== */
renderStrips();
updateDepotDest();
refreshAll();
</script>
</body>
</html>
