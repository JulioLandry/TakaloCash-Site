<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TakaloCash – Service</title>
<style>
  :root{
    --brand:#ffbf00;        /* volamena */
    --brand-2:#d9a300;
    --dark:#0c0c0c;
    --ink:#222;
    --muted:#6d6d6d;
    --grey:#f5f5f5;
    --ok:#16a34a;
    --danger:#dc2626;
    --pill:999px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:#fff;color:#111;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial}
  /* ===== Header ===== */
  header{background:#0c0c0c;color:#fff;padding:24px 16px 8px;position:sticky;top:0;z-index:10;box-shadow:0 6px 24px rgba(0,0,0,.2)}
  .topbar{max-width:980px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;flex-direction:column}
  .brand .title{font-weight:1000;letter-spacing:.5px;font-size:30px;color:var(--brand)}
  .brand .subtitle{
    margin-top:6px;display:inline-block;padding:6px 12px;background:#eee;color:#111;
    border-radius:8px;font-weight:800;letter-spacing:3px;text-transform:lowercase;
    font-style:italic; text-shadow:0 1px 0 #fff, 0 0 6px rgba(255,191,0,.45);
  }
  .flags{display:flex;gap:8px}
  .flag{width:28px;height:18px;border-radius:3px;overflow:hidden;cursor:pointer;border:1px solid #0003;background:#fff}
  .lang-active{outline:2px solid var(--brand)}
  .tabs{max-width:980px;margin:14px auto 0;display:flex;gap:10px;flex-wrap:wrap;padding:0 4px 10px}
  .tab{background:var(--brand);border:none;color:#111;font-weight:900;padding:10px 18px;border-radius:var(--pill);cursor:pointer;letter-spacing:.5px;font-size:15px;box-shadow:0 3px 0 var(--brand-2)}
  .tab[aria-selected="true"]{background:#111;color:#fff;box-shadow:0 3px 0 #000}
  main{max-width:980px;margin:18px auto;padding:0 12px 80px}

  /* ===== common UI ===== */
  .panel{background:#fff;border:1px solid #eee;border-radius:16px;padding:14px 14px 18px;box-shadow:0 10px 30px rgba(0,0,0,.06);margin-bottom:14px}
  .label{font-size:13px;color:#444;margin-bottom:6px;font-weight:800;letter-spacing:.2px}
  .field{position:relative}
  .field input, .field select, .field textarea{
    width:100%;padding:14px;border-radius:12px;border:1px solid #ddd;background:#f9f9f9;font-size:16px;outline:none
  }
  .field input[readonly]{background:#f3f3f3;color:#333;cursor:not-allowed}
  .suffix{position:absolute;right:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:800;background:#111;color:#fff;border-radius:10px;padding:4px 8px}
  .prefix{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:12px;font-weight:800;color:#555;padding:4px 8px}
  .grid{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:760px){.grid{grid-template-columns:1fr 1fr}}
  .note{font-size:12px;color:#333;margin-top:6px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center}
  .pay-opts, .crypto-strip, .ewallet-strip{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 8px}
  .chip, .paybtn, .ewbtn{
    padding:6px 10px;border-radius:14px;background:#111;color:#fff;font-weight:700;font-size:12px;cursor:pointer;border:1px solid #000;user-select:none
  }
  .chip[aria-pressed="true"], .paybtn[aria-pressed="true"], .ewbtn[aria-pressed="true"]{background:var(--brand);color:#111;border-color:#d6a800}
  .expand-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:14px;border:1px dashed #999;background:#fff;color:#111;font-weight:800;cursor:pointer}
  .expand-btn svg{width:14px;height:14px}
  .checkbox{display:flex;gap:8px;align-items:flex-start;margin-top:6px}
  .actions{display:flex;gap:10px;align-items:center;margin-top:10px}
  .btn{border:none;border-radius:16px;padding:12px 16px;font-weight:900;cursor:pointer}
  .btn-primary{background:var(--brand);color:#111}
  .btn-primary:disabled{opacity:.5;cursor:not-allowed}
  .btn-ghost{background:#000;color:#fff}
  .copybtn{border:none;border-radius:10px;padding:10px 12px;background:#111;color:#fff;cursor:pointer;font-weight:800}

  /* Crypto selector */
  .crypto-selector {
    position: relative;
    display: inline-block;
  }
  .crypto-selector-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
  }
  .crypto-selector-btn .arrow {
    transition: transform 0.2s;
  }
  .crypto-selector-btn.open .arrow {
    transform: rotate(180deg);
  }
  .crypto-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 100;
    max-height: 300px;
    overflow-y: auto;
    display: none;
    width: 200px;
  }
  .crypto-dropdown.open {
    display: block;
  }
  .crypto-item {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .crypto-item:hover {
    background: #f5f5f5;
  }
  .crypto-item.active {
    background: #ffbf0022;
  }
  .crypto-rate {
    font-size: 12px;
    color: #666;
  }

  /* Toast & confirm */
  .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;padding:12px 16px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);display:none;z-index:50}
  .toast.show{display:block}
  dialog{border:none;border-radius:16px;padding:18px;max-width:720px;width:92%}
  dialog::backdrop{background:rgba(0,0,0,.5)}

  /* ===== footer ===== */
  footer{background:#111;color:#fff;padding:24px 12px 40px}
  .footer-wrap{max-width:980px;margin:0 auto}
  .contact-title{font-weight:1000;letter-spacing:.3px;margin-bottom:8px}
  .cta{display:flex;gap:12px;flex-wrap:wrap}
  .ctaitem{display:inline-flex;align-items:center;gap:8px;background:#fff;color:#111;border-radius:12px;padding:8px 12px;font-weight:900;cursor:pointer}
  .ctaitem[data-kind="fb"]{background:#1877f2;color:#fff}
  .ctaitem[data-kind="wa"]{background:#25D366;color:#fff}
  .ctaitem svg{width:18px;height:18px}
  .legal{display:flex;gap:12px;flex-wrap:wrap;margin-top:14px}
  .legal a{color:#9ad3ff;text-decoration:underline;cursor:pointer}
  .copy{font-size:12px;color:#ddd;margin-top:12px}
</style>
</head>
<body>

<header>
  <div class="topbar">
    <div class="brand">
      <div class="title">TAKALOCASH</div>
      <div class="subtitle">Simple – rapide – sécurisé</div>
    </div>
    <div class="flags" aria-label="Language">
      <!-- FR -->
      <button class="flag lang-active" id="lang-fr" aria-pressed="true" title="Français">
        <svg viewBox="0 0 3 2" width="28" height="18">
          <rect width="1" height="2" x="0" y="0" fill="#0055a4"/>
          <rect width="1" height="2" x="1" y="0" fill="#fff"/>
          <rect width="1" height="2" x="2" y="0" fill="#ef4135"/>
        </svg>
      </button>
      <!-- MG -->
      <button class="flag" id="lang-mg" aria-pressed="false" title="Malagasy">
        <svg viewBox="0 0 3 2" width="28" height="18">
          <rect width="1" height="2" x="0" y="0" fill="#ffffff"/>
          <rect width="2" height="1" x="1" y="0" fill="#fc3d32"/>
          <rect width="2" height="1" x="1" y="1" fill="#007e3a"/>
        </svg>
      </button>
    </div>
  </div>

  <div class="tabs" role="tablist" aria-label="Service">
    <button class="tab" role="tab" id="tab-depot" aria-selected="true" data-tab="depot">DÉPÔT</button>
    <button class="tab" role="tab" id="tab-retrait" aria-selected="false" data-tab="retrait">RETRAIT</button>
    <button class="tab" role="tab" id="tab-transfert" aria-selected="false" data-tab="transfert">TRANSFERT</button>
  </div>
</header>

<main>
  <!-- Crypto rates display -->
  <div class="panel" id="rates-panel">
    <div class="row" style="justify-content: space-between; flex-wrap: wrap; align-items: center;">
      <div><b>Cours actuels:</b></div>
      <div class="crypto-selector" id="crypto-selector">
        <div class="crypto-selector-btn" id="crypto-selector-btn">
          <span id="current-rate-display">Chargement...</span>
          <svg class="arrow" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
        <div class="crypto-dropdown" id="crypto-dropdown"></div>
      </div>
    </div>
  </div>

  <!-- STRIPS (top of every tab) -->
  <div class="crypto-strip" id="cryptoStrip"></div>
  <div class="ewallet-strip" id="ewalletStrip"></div>

  <!-- ================== DEPOT ================== -->
  <section id="panel-depot" class="panel" role="tabpanel" aria-labelledby="tab-depot">
    <!-- Expanders -->
    <div class="row">
      <button class="expand-btn" id="toggleMoreCryptos">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Plus de cryptos
      </button>
      <button class="expand-btn" id="toggleMoreEwallets">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Plus d'e-wallets
      </button>
    </div>

    <div class="grid" style="margin-top:10px">
      <!-- ENVOIE (Montant + Paiement) -->
      <div>
        <div class="label">Envoie</div>
        <div class="field">
          <input id="dep-amount-ariary" type="number" inputmode="decimal" placeholder="montant en ariary" />
          <span class="prefix">MGA</span>
          <span class="suffix" id="dep-pay-logo">Mvola</span>
        </div>

        <div class="note">Choisir le moyen de paiement:</div>
        <div class="pay-opts" id="dep-pay-opts">
          <button class="paybtn" data-pay="mvola" aria-pressed="true">Mvola</button>
          <button class="paybtn" data-pay="orange">Orange Money</button>
          <button class="paybtn" data-pay="airtel">Airtel Money</button>
        </div>

        <div class="note muted" id="dep-pay-hint">
          Envoyer à <span class="chip" id="dep-pay-dest">0347451051</span> — Nom: <b id="dep-pay-name">Julio Landry</b>
        </div>
      </div>

      <!-- REÇU (Crypto amount + Adresse preset selon sélection) -->
      <div>
        <div class="label">Reçu</div>
        <div class="field">
          <input id="dep-amount-crypto" type="text" placeholder="0.00000000" readonly />
          <span class="suffix" id="dep-crypto-suffix">BTC</span>
        </div>
        <div class="note muted">
          <div id="dep-rate-note">1 BTC = … MGA</div>
          <div id="dep-fee-note">Frais: 0,3%</div>
        </div>

        <div class="label" id="dep-addr-label">Adresse de paiement</div>
        <div class="row">
          <div class="field" style="flex:1">
            <input id="dep-addr" type="text" readonly value="" />
          </div>
          <button class="copybtn" id="dep-copy">Copier</button>
        </div>
        <div class="note muted" id="dep-addr-note">Adresse/identifiant présaisie selon le moyen sélectionné (non modifiable).</div>
      </div>
    </div>

    <div class="label" style="margin-top:6px">Nom dans le compte</div>
    <div class="field"><input id="dep-holder" type="text" placeholder="Ex: Rakoto" /></div>

    <label class="checkbox">
      <input id="dep-accept" type="checkbox" />
      <span class="muted">Je certifie avoir lu et pris connaissance des conditions générales d'utilisation du site internet et les accepter sans réserve.</span>
    </label>
    <div class="actions">
      <button id="dep-preview" class="btn btn-primary" disabled>Aperçu</button>
      <span class="muted" id="dep-msg"></span>
    </div>
  </section>

  <!-- ================== RETRAIT ================== -->
  <section id="panel-retrait" class="panel" role="tabpanel" aria-labelledby="tab-retrait" hidden>
    <div class="row">
      <button class="expand-btn" id="toggleMoreCryptos2">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Plus de cryptos
      </button>
      <button class="expand-btn" id="toggleMoreEwallets2">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Plus d'e-wallets
      </button>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <div class="label">Envoie</div>
        <div class="field">
          <input id="ret-amount-crypto" type="number" inputmode="decimal" placeholder="0.00000000" />
          <span class="suffix" id="ret-crypto-suffix">BTC</span>
        </div>
        <div class="note">
          <div class="row">
            <div class="field">
              <div class="label">Adresse (nô)</div>
              <input id="ret-our-addr" type="text" readonly />
            </div>
            <button id="ret-copy" class="btn btn-ghost">Copier</button>
          </div>
          <div class="muted" id="ret-crypto-only">Envoyer seulement en <b>BTC</b></div>
        </div>
      </div>

      <div>
        <div class="label">Reçu</div>
        <div class="field">
          <input id="ret-amount-ariary" type="text" placeholder="0 MGA" readonly />
          <span class="prefix">MGA</span>
          <span class="suffix" id="ret-wallet-logo">Mvola</span>
        </div>
        <div class="note muted">
          <div id="ret-rate-note">1 BTC = … MGA</div>
          <div id="ret-fee-note">Frais: 0,5%</div>
        </div>

        <div class="label">Moyen de réception</div>
        <div class="field">
          <input id="ret-phone" type="tel" placeholder="Numéro (mobile money / e-wallet)" />
          <span class="suffix" id="ret-wallet-icon">Mvola</span>
        </div>
        <div class="note muted" id="ret-wallet-note">Nom dans le compte Mvola</div>

        <div class="label">Nom du titulaire</div>
        <div class="field"><input id="ret-name" type="text" placeholder="Ex: Rakoto" /></div>
      </div>
    </div>

    <label class="checkbox">
      <input id="ret-accept" type="checkbox" />
      <span class="muted">Je certifie avoir lu et pris connaissance des conditions générales d'utilisation du site internet et les accepter sans réserve.</span>
    </label>
    <div class="actions">
      <button id="ret-preview" class="btn btn-primary" disabled>Aperçu</button>
      <span class="muted" id="ret-msg"></span>
    </div>
  </section>

  <!-- ================== TRANSFERT ================== -->
  <section id="panel-transfert" class="panel" role="tabpanel" aria-labelledby="tab-transfert" hidden>
    <div class="row">
      <button class="expand-btn" id="toggleMoreCryptos3">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Plus de cryptos
      </button>
      <button class="expand-btn" id="toggleMoreEwallets3">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        Plus d'e-wallets
      </button>
    </div>

    <div class="grid" style="margin-top:10px">
      <div>
        <div class="label">Envoie</div>
        <div class="field">
          <input id="trf-amount-top" type="number" inputmode="decimal" placeholder="0.00000000" />
          <span class="suffix" id="trf-top-suffix">BTC</span>
        </div>
        <div class="note muted" id="trf-top-note">Crypto source: BTC</div>
      </div>

      <div>
        <div class="label">Reçu</div>
        <div class="field">
          <input id="trf-amount-bot" type="text" placeholder="0.00000000" readonly />
          <span class="suffix" id="trf-bot-suffix">USDT</span>
        </div>
        <div class="note muted" id="trf-rate-note">1 BTC = 35 USDT</div>
      </div>
    </div>

    <div class="label" style="margin-top:8px">Choisir la crypto/e-wallet à recevoir</div>
    <div class="crypto-strip" id="cryptoStripTransfer"></div>
    <div class="ewallet-strip" id="ewalletStripTransfer"></div>

    <div class="label" style="margin-top:8px">Adresse de réception</div>
    <div class="field">
      <input id="trf-dest-addr" type="text" placeholder="Adresse de votre wallet" />
    </div>

    <label class="checkbox">
      <input id="trf-accept" type="checkbox" />
      <span class="muted">Je certifie avoir lu et pris connaissance des conditions générales d'utilisation du site internet et les accepter sans réserve.</span>
    </label>
    <div class="actions">
      <button id="trf-preview" class="btn btn-primary" disabled>Aperçu</button>
      <span class="muted" id="trf-msg"></span>
    </div>
  </section>
</main>

<footer>
  <div class="footer-wrap">
    <div class="contact-title">Contact</div>
    <div class="cta">
      <div class="ctaitem" data-kind="email" id="cta-email" title="Email">
        <!-- envelope -->
        <svg viewBox="0 0 24 24" fill="none"><path d="M4 6h16v12H4z" stroke="currentColor" stroke-width="2"/><path d="M4 7l8 6 8-6" stroke="currentColor" stroke-width="2"/></svg>
        Email
      </div>
      <div class="ctaitem" data-kind="call" id="cta-call" title="Téléphone">
        <!-- phone -->
        <svg viewBox="0 0 24 24" fill="none"><path d="M22 16.92v2a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.12 3.9 2 2 0 0 1 4.11 2h2a2 2 0 0 1 2 1.72c.12.9.3 1.78.57 2.63a2 2 0 0 1-.45 2.11L7.09 9.91a16 16 0 0 0 6 6l1.45-1.14a2 2 0 0 1 2.11-.45c.85.27 1.73.45 2.63.57A2 2 0 0 1 22 16.92z" stroke="currentColor" stroke-width="2"/></svg>
        Téléphone
      </div>
      <div class="ctaitem" data-kind="fb" id="cta-fb" title="Facebook">
        <!-- F -->
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M13 22v-8h3l1-4h-4V7c0-1.1.9-2 2-2h2V1h-3a5 5 0 0 0-5 5v4H6v4h3v8h4z"/></svg>
        Facebook
      </div>
      <div class="ctaitem" data-kind="wa" id="cta-wa" title="WhatsApp">
        <!-- whatsapp -->
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4.9A9.8 9.8 0 0 0 12.2 2C6.9 2 2.6 6.3 2.6 11.6c0 2 .6 3.9 1.8 5.5L3 22l4.9-1.3c1.5.8 3.2 1.2 4.9 1.2 5.3 0 9.6-4.3 9.6-9.6 0-2.6-1-5-2.7-6.8zM12.8 20c-1.5 0-2.9-.4-4.2-1.1l-.3-.2-2.9.8.8-2.8-.2-.3c-1-1.3-1.6-2.9-1.6-4.6C4.4 7.7 8 4.1 12.2 4.1c2.1 0 4.1.8 5.6 2.3 1.5 1.5 2.3 3.5 2.3 5.6 0 4.2-3.6 7.9-7.3 8z"/><path d="M16.6 13.7c-.2-.1-1.3-.7-1.5-.8-.2-.1-.4-.1-.5.1-.2.2-.6.8-.8 1-.1.1-.3.2-.5.1-.2-.1-.9-.3-1.7-1-.6-.6-1-1.2-1.1-1.4-.1-.2 0-.4.1-.5.1-.1.2-.3.3-.5.1-.1.1-.2.2-.4.1-.2 0-.3 0-.4s-.5-1.1-.7-1.5c-.2-.4-.4-.3-.5-.3h-.4c-.1 0-.4.1-.6.3-.2.2-.8.8-.8 2s.8 2.3.9 2.5c.1.2 1.6 2.6 3.8 3.6.5.2.9.4 1.2.5.5.2 1 .2 1.3.1.4-.1 1.3-.5 1.5-1 .2-.5.2-.9.1-1-.1-.1-.2-.1-.4-.2z"/></svg>
        WhatsApp
      </div>
    </div>

    <div class="legal">
      <a data-modal="cgu">Conditions générales d'utilisation</a>
      <a data-modal="mentions">Mentions légales</a>
      <a data-modal="privacy">Politique de confidentialité</a>
    </div>

    <div class="copy">© 2025 TakaloCash. Tous droits réservés.</div>
  </div>
</footer>

<!-- LEGAL MODALS -->
<dialog id="dlg-cgu"><h3>Conditions générales</h3><p>Exemple de conditions… (soloina amin'ny tena pejy-nao).</p><div style="text-align:right;margin-top:10px"><button onclick="this.closest('dialog').close()">OK</button></div></dialog>
<dialog id="dlg-mentions"><h3>Mentions légales</h3><p>Exemple de mentions…</p><div style="text-align:right;margin-top:10px"><button onclick="this.closest('dialog').close()">OK</button></div></dialog>
<dialog id="dlg-privacy"><h3>Politique de confidentialité</h3><p>Exemple de politique…</p><div style="text-align:right;margin-top:10px"><button onclick="this.closest('dialog').close()">OK</button></div></dialog>

<!-- Confirm dialog (native) is used; Toast below -->
<div class="toast" id="toast"></div>

<!-- EmailJS SDK (front-end) -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
/* ================== CONFIG ================== */
const CONFIG = {
  // ---- EmailJS (DEMO values — soloinao) ----
  emailjsPublicKey : "DEMO_PUBLIC_KEY_REPLACE_ME",
  emailjsServiceId : "DEMO_SERVICE_ID",
  emailjsTemplateId: "DEMO_TEMPLATE_ID",
  // ---- Contact links ----
  emailTo   : "contact@takalocash.mg",
  phoneCall : "+261347451051",
  facebook  : "https://facebook.com/",
  whatsapp  : "https://wa.me/261347451051",
  // ---- Our receiving addresses / IDs ----
  wallets: {
    // Mobile money numbers (used as "destination" rehefa voafidy izy)
    mvola : {label:"Mvola",  num:"0347451051", name:"Julio Landry", logo:"Mvola"},
    orange: {label:"Orange Money", num:"0324923117", name:"Julio Landry", logo:"Orange"},
    airtel: {label:"Airtel Money", num:"0331483290", name:"Julio RANDRIANARIMANANA", logo:"Airtel"},
    // eWallets
    wise:   {label:"Wise",   addr:"WISE-ACCOUNT-ID-EXEMPLE",    name:"TakaloCash", logo:"$"},
    paypal: {label:"PayPal", addr:"paypal@takalocash.mg",       name:"TakaloCash", logo:"$"},
    skrill: {label:"Skrill", addr:"skrill@takalocash.mg",       name:"TakaloCash", logo:"€"},
    payoneer:{label:"Payoneer", addr:"PAYONEER-ID-EXEMPLE",     name:"TakaloCash", logo:"$"}
  },
  cryptoAddrs: {
    BTC:"bc1-EXEMPLE-BTC-ADDRESS",
    ETH:"0xEXEMPLEETHADDRESS",
    LTC:"ltc1qEXEMPLE",
    BCH:"qzEXEMPLEBCH",
    USDT:"TEXEMPLEUSDT",
    USDC:"0xEXEMPLEUSDC",
    BUSD:"0xEXEMPLEBUSD",
    DAI:"0xEXEMPLEDAI",
    ADA:"addr1EXEMPLEADA",
    SOL:"SoLExemple1111",
    DOT:"dotEXEMPLE",
    LINK:"0xEXEMPLELINK",
    UNI:"0xEXEMPLEUNI",
    CAKE:"0xEXEMPLECAKE"
  },
  cryptosPrimary: ["BTC","ETH","USDT","LTC","BCH"],
  cryptosExtra:   ["USDC","BUSD","DAI","ADA","SOL","DOT","LINK","UNI","CAKE"],
  ewalletsPrimary:["wise","paypal","skrill","payoneer"],
  // rates: 1 unit crypto = MGA (exemple)
  ratesMGA: {
    BTC:150_000_000, ETH:9_000_000, LTC:350_000, BCH:2_800_000,
    USDT:4_500, USDC:4_500, BUSD:4_500, DAI:4_500,
    ADA:1_200, SOL:700_000, DOT:120_000, LINK:80_000, UNI:60_000, CAKE:30_000
  },
  fees: { depot:0.003, retrait:0.005, transfert:0.004 }
};

/* ================== INIT ================== */
(function(){
  if(window.emailjs){
    try{ emailjs.init({publicKey: CONFIG.emailjsPublicKey}); }catch(e){}
  }
})();
const $ = s=>document.querySelector(s);
const $$ = s=>document.querySelectorAll(s);
function toast(msg, ms=2500){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), ms); }

/* ===== State ===== */
let currentLang="fr";
let currentCrypto="BTC";          // crypto selection
let transferTarget="USDT";        // target crypto/ewallet
let payChoice="mvola";            // payment choice (can be mobile, ewallet, or crypto code)
let showMoreCryptos=false, showMoreEwallets=false;
let showMoreCryptos2=false, showMoreEwallets2=false;
let showMoreCryptos3=false, showMoreEwallets3=false;

/* ===== Build selectable chips ===== */
function chip(label, active, onClick){
  const b=document.createElement("button");
  b.className="chip"; b.textContent=label; b.setAttribute("aria-pressed", active?"true":"false");
  b.addEventListener("click", onClick); return b;
}
function ewbtn(key, label, active, onClick){
  const b=document.createElement("button");
  b.className="ewbtn"; b.textContent=label; b.setAttribute("aria-pressed", active?"true":"false");
  b.dataset.key=key; b.addEventListener("click", onClick); return b;
}

function renderStrips(){
  // top crypto strip (main)
  const strip=$("#cryptoStrip"); strip.innerHTML="";
  [...CONFIG.cryptosPrimary, ...(showMoreCryptos?CONFIG.cryptosExtra:[])].forEach(sym=>{
    strip.appendChild(chip(sym, sym===currentCrypto, ()=>{ currentCrypto=sym; if(payChoice in CONFIG.wallets || CONFIG.cryptoAddrs[payChoice]){/* keep */} refreshAll(); }));
  });
  // top ewallet strip
  const ew=$("#ewalletStrip"); ew.innerHTML="";
  [...CONFIG.ewalletsPrimary, ...(showMoreEwallets?[]:[])].forEach(k=>{
    const lab=CONFIG.wallets[k].label; ew.appendChild(ewbtn(k, lab, k===payChoice, ()=>{ payChoice=k; refreshAll(); }));
  });
  // transfer strips
  const stripT=$("#cryptoStripTransfer"); if(stripT){ stripT.innerHTML="";
    [...CONFIG.cryptosPrimary, ...(showMoreCryptos3?CONFIG.cryptosExtra:[])].forEach(sym=>{
      stripT.appendChild(chip(sym, sym===transferTarget, ()=>{ transferTarget=sym; refreshTransfer(); }));
    });
  }
  const ewT=$("#ewalletStripTransfer"); if(ewT){ ewT.innerHTML="";
    CONFIG.ewalletsPrimary.forEach(k=>{
      const lab=CONFIG.wallets[k].label; ewT.appendChild(ewbtn(k, lab, k===transferTarget, ()=>{ transferTarget=k; refreshTransfer(); }));
    });
  }
}

/* ===== Crypto Selector ===== */
function setupCryptoSelector() {
  const selectorBtn = $("#crypto-selector-btn");
  const dropdown = $("#crypto-dropdown");
  
  selectorBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    selectorBtn.classList.toggle("open");
    dropdown.classList.toggle("open");
  });
  
  // Close dropdown when clicking outside
  document.addEventListener("click", (e) => {
    if (!selectorBtn.contains(e.target) && !dropdown.contains(e.target)) {
      selectorBtn.classList.remove("open");
      dropdown.classList.remove("open");
    }
  });
  
  // Update dropdown content
  updateCryptoDropdown();
}

function updateCryptoDropdown() {
  const dropdown = $("#crypto-dropdown");
  dropdown.innerHTML = "";
  
  // Add all cryptos to dropdown
  [...CONFIG.cryptosPrimary, ...CONFIG.cryptosExtra].forEach(sym => {
    const item = document.createElement("div");
    item.className = "crypto-item";
    if (sym === currentCrypto) item.classList.add("active");
    
    item.innerHTML = `
      <span>${sym}</span>
      <span class="crypto-rate">${CONFIG.ratesMGA[sym]?.toLocaleString() || '...'} MGA</span>
    `;
    
    item.addEventListener("click", () => {
      currentCrypto = sym;
      $("#crypto-selector-btn").classList.remove("open");
      dropdown.classList.remove("open");
      refreshAll();
    });
    
    dropdown.appendChild(item);
  });
}

function updateCurrentRateDisplay() {
  const display = $("#current-rate-display");
  if (currentCrypto && CONFIG.ratesMGA[currentCrypto]) {
    display.textContent = `1 ${currentCrypto} = ${CONFIG.ratesMGA[currentCrypto].toLocaleString()} MGA`;
  } else {
    display.textContent = "Chargement...";
  }
}

/* ===== Crypto Rates ===== */
const cryptoMapping = {
  BTC:"btc-bitcoin",
  ETH:"eth-ethereum",
  USDT:"usdt-tether",
  LTC:"ltc-litecoin",
  BCH:"bch-bitcoin-cash",
  USDC:"usdc-usd-coin",
  BUSD:"busd-binance-usd",
  DAI:"dai-dai",
  ADA:"ada-cardano",
  SOL:"sol-solana",
  DOT:"dot-polkadot",
  LINK:"link-chainlink",
  UNI:"uni-uniswap",
  CAKE:"cake-pancakeswap"
};

const fallbackRates = {
  BTC:150000,
  ETH:9000,
  USDT:1,
  LTC:350,
  BCH:2800,
  USDC:1,
  BUSD:1,
  DAI:1,
  ADA:1.2,
  SOL:70,
  DOT:12,
  LINK:8,
  UNI:6,
  CAKE:3
};

let ratesUSD = {};

async function fetchRate(sym){
  const id = cryptoMapping[sym];
  try{
    const resp = await fetch(`https://api.coinpaprika.com/v1/tickers/${id}`);
    if(!resp.ok) throw new Error("API error");
    const data = await resp.json();
    return data.quotes.USD.price || fallbackRates[sym];
  }catch(e){
    console.warn(`Erreur pour ${sym}:`, e);
    return fallbackRates[sym];
  }
}

async function updateRates(){
  const allCryptos = [...CONFIG.cryptosPrimary, ...CONFIG.cryptosExtra];
  
  for(const sym of allCryptos){
    const rate = await fetchRate(sym);
    ratesUSD[sym] = rate;
    
    // Update config with live rates (scaled from USD to MGA based on fallback ratio)
    if (fallbackRates[sym] && rate) {
      CONFIG.ratesMGA[sym] = Math.round(rate * (CONFIG.ratesMGA[sym] / fallbackRates[sym]));
    }
  }
  
  // Update UI
  updateCurrentRateDisplay();
  updateCryptoDropdown();
  refreshAll();
}

/* ===== Expanders (+) ===== */
function toggleBtn(el, open){
  el.innerHTML = open
    ? `<svg viewBox="0 0 24 24" fill="none"><path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Réduire`
    : `<svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg> Plus`;
}
$("#toggleMoreCryptos").addEventListener("click", ()=>{ showMoreCryptos=!showMoreCryptos; renderStrips(); toggleBtn($("#toggleMoreCryptos"), showMoreCryptos); });
$("#toggleMoreEwallets").addEventListener("click", ()=>{ showMoreEwallets=!showMoreEwallets; renderStrips(); toggleBtn($("#toggleMoreEwallets"), showMoreEwallets); });
$("#toggleMoreCryptos2").addEventListener("click", ()=>{ showMoreCryptos2=!showMoreCryptos2; showMoreCryptos=showMoreCryptos2; renderStrips(); toggleBtn($("#toggleMoreCryptos2"), showMoreCryptos2); });
$("#toggleMoreEwallets2").addEventListener("click", ()=>{ showMoreEwallets2=!showMoreEwallets2; showMoreEwallets=showMoreEwallets2; renderStrips(); toggleBtn($("#toggleMoreEwallets2"), showMoreEwallets2); });
$("#toggleMoreCryptos3").addEventListener("click", ()=>{ showMoreCryptos3=!showMoreCryptos3; renderStrips(); toggleBtn($("#toggleMoreCryptos3"), showMoreCryptos3); });
$("#toggleMoreEwallets3").addEventListener("click", ()=>{ showMoreEwallets3=!showMoreEwallets3; renderStrips(); toggleBtn($("#toggleMoreEwallets3"), showMoreEwallets3); });

/* ===== Tabs ===== */
$$(".tab").forEach(t=>{
  t.addEventListener("click",()=>{
    $$(".tab").forEach(x=>x.setAttribute("aria-selected","false"));
    t.setAttribute("aria-selected","true");
    const tab=t.dataset.tab;
    $("#panel-depot").hidden = tab!=="depot";
    $("#panel-retrait").hidden = tab!=="retrait";
    $("#panel-transfert").hidden = tab!=="transfert";
    refreshAll();
  });
});

/* ===== Payment options (Depot quick buttons) ===== */
$("#dep-pay-opts").addEventListener("click",(e)=>{
  const btn=e.target.closest(".paybtn"); if(!btn) return;
  payChoice = btn.dataset.pay; // can be mobile money key OR ewallet key OR crypto code
  $$("#dep-pay-opts .paybtn").forEach(b=>b.setAttribute("aria-pressed", b.dataset.pay===payChoice?"true":"false"));
  updateDepotDest();
});

/* ===== Accept checkboxes -> enable buttons ===== */
["dep","ret","trf"].forEach(k=>{
  $(`#${k}-accept`).addEventListener("change",()=>{ $(`#${k}-preview`).disabled = ! $(`#${k}-accept`).checked; });
});

/* ===== Copy buttons ===== */
$("#dep-copy").addEventListener("click",()=>{ const el=$("#dep-addr"); el.select(); document.execCommand("copy"); toast("Copié !"); });
$("#ret-copy").addEventListener("click",()=>{ $("#ret-our-addr").select(); document.execCommand("copy"); toast("Copié !"); });

/* ===== Inputs & selects ===== */
$("#dep-amount-ariary").addEventListener("input", refreshDepot);
$("#ret-amount-crypto").addEventListener("input", refreshRetrait);
$("#ret-phone").addEventListener("input", function(){
  const num = this.value.trim();
  let wallet = "mvola";
  if(num.startsWith("032") || num.startsWith("037")) wallet = "orange";
  else if(num.startsWith("033")) wallet = "orange";
  $("#ret-wallet-icon").textContent = CONFIG.wallets[wallet]?.logo || "";
});
$("#trf-amount-top").addEventListener("input", refreshTransfer);

/* ===== Lang flags (kept, tsy ovaina ny style) ===== */
$("#lang-fr").addEventListener("click", ()=>{ setLang("fr"); });
$("#lang-mg").addEventListener("click", ()=>{ setLang("mg"); });
function setLang(l){
  currentLang=l;
  $("#lang-fr").classList.toggle("lang-active", l==="fr");
  $("#lang-mg").classList.toggle("lang-active", l==="mg");
  // (mitahiry ny wording ankehitriny, tsy ovaina firy; minimalist)
}

/* ===== Footer CTAs ===== */
$("#cta-email").addEventListener("click",()=>window.location.href=`mailto:${CONFIG.emailTo}`);
$("#cta-call").addEventListener("click",()=>window.location.href=`tel:${CONFIG.phoneCall}`);
$("#cta-fb").addEventListener("click",()=>window.open(CONFIG.facebook,"_blank"));
$("#cta-wa").addEventListener("click",()=>window.open(CONFIG.whatsapp,"_blank"));
$$(".legal a").forEach(a=>a.addEventListener("click",()=>$("#dlg-"+a.dataset.modal).showModal()));

/* ===== Conversion helpers ===== */
function rateLine(sym){ const mg=CONFIG.ratesMGA[sym]; return `1 ${sym} = ${mg?mg.toLocaleString(): "—"} MGA`; }
function crossRate(a,b){ const A=CONFIG.ratesMGA[a]; const B=CONFIG.ratesMGA[b]; return (A && B)? +(A/B).toFixed(8) : "—"; }
const applyFee=(x,f)=> x*(1-f);

/* ===== Update DEST (Depot) depending on payChoice ===== */
function updateDepotDest(){
  const isMobile = ["mvola","orange","airtel"].includes(payChoice);
  const isEwallet = Object.keys(CONFIG.wallets).includes(payChoice) && !isMobile;
  const isCrypto = !!CONFIG.cryptoAddrs[payChoice] || !!CONFIG.cryptoAddrs[currentCrypto];

  if(isMobile){
    // Number + name
    const w=CONFIG.wallets[payChoice];
    $("#dep-pay-dest").textContent = w.num;
    $("#dep-pay-name").textContent = w.name;
    $("#dep-pay-logo").textContent = w.logo;
    // address field becomes their number/ID for clarity but read-only
    $("#dep-addr").value = w.num;
    $("#dep-addr-label").textContent = "Numéro de paiement";
    $("#dep-addr-note").textContent = "Numéro présaisi (non modifiable).";
  }else if(isEwallet){
    const w=CONFIG.wallets[payChoice];
    $("#dep-pay-dest").textContent = w.addr || w.num || "";
    $("#dep-pay-name").textContent = w.name || "TakaloCash";
    $("#dep-pay-logo").textContent = w.logo;
    $("#dep-addr").value = w.addr || "";
    $("#dep-addr-label").textContent = "Adresse de paiement";
    $("#dep-addr-note").textContent = "Adresse/identifiant présaisie selon le moyen sélectionné (non modifiable).";
  }else if(isCrypto){
    // payChoice is a crypto code (BTC/USDT/…)
    const sym = /[A-Z]{3,5}/.test(payChoice) ? payChoice : currentCrypto;
    const addr = CONFIG.cryptoAddrs[sym] || "";
    $("#dep-pay-dest").textContent = addr.slice(0,10)+"…";
    $("#dep-pay-name").textContent = "TakaloCash";
    $("#dep-pay-logo").textContent = sym;
    $("#dep-addr").value = addr;
    $("#dep-addr-label").textContent = "Adresse de paiement";
    $("#dep-addr-note").textContent = "Adresse crypto présaisie (non modifiable).";
  }else{
    $("#dep-pay-dest").textContent = "";
    $("#dep-pay-name").textContent = "";
    $("#dep-addr").value = "";
  }
}

/* ===== Refreshers ===== */
function refreshDepot(){
  // ariary -> selected CRYPTO (currentCrypto) – depot fee
  const mga = +($("#dep-amount-ariary").value || 0);
  const unitMGA = CONFIG.ratesMGA[currentCrypto] || 0;
  const crypto = unitMGA ? applyFee(mga/unitMGA, CONFIG.fees.depot) : 0;
  $("#dep-amount-crypto").value = crypto ? crypto.toFixed(8) : "";
  $("#dep-crypto-suffix").textContent = currentCrypto;
  $("#dep-rate-note").textContent = rateLine(currentCrypto);
  $("#dep-fee-note").textContent = "Frais: " + (CONFIG.fees.depot*100).toFixed(1) + "%";
  // keep address label consistent with current choice
  updateDepotDest();
}
function refreshRetrait(){
  const qty = +($("#ret-amount-crypto").value || 0);
  const unitMGA = CONFIG.ratesMGA[currentCrypto] || 0;
  const mga = applyFee(qty*unitMGA, CONFIG.fees.retrait);
  $("#ret-amount-ariary").value = mga ? Math.round(mga).toLocaleString() : "";
  $("#ret-rate-note").textContent = rateLine(currentCrypto);
  $("#ret-fee-note").textContent = "Frais: " + (CONFIG.fees.retrait*100).toFixed(1) + "%";
  $("#ret-crypto-suffix").textContent = currentCrypto;
  $("#ret-our-addr").value = CONFIG.cryptoAddrs[currentCrypto] || "";
  $("#ret-crypto-only").innerHTML = "Envoyer seulement en <b>"+currentCrypto+"</b>";
}
function refreshTransfer(){
  const qty = +($("#trf-amount-top").value || 0);
  const isTargetCrypto = /^[A-Z]{3,5}$/.test(transferTarget);
  let rate = "—", out = 0;
  if(isTargetCrypto){
    rate = crossRate(currentCrypto, transferTarget);
    out = applyFee(qty * (Number(rate)||0), CONFIG.fees.transfert);
  }else{
    // target ewallet: treat as stable token USDT as proxy convert
    rate = crossRate(currentCrypto, "USDT");
    out = applyFee(qty * (Number(rate)||0), CONFIG.fees.transfert);
  }
  $("#trf-amount-bot").value = out ? out.toFixed(8) : "";
  $("#trf-top-suffix").textContent = currentCrypto;
  $("#trf-bot-suffix").textContent = isTargetCrypto? transferTarget : transferTarget.toUpperCase();
  $("#trf-top-note").textContent = "Crypto source: " + currentCrypto;
  $("#trf-rate-note").textContent = `1 ${currentCrypto} = ${rate} ${isTargetCrypto? transferTarget : "USDT"}`;
  // update active chips/buttons
  $$("#cryptoStrip .chip").forEach(b=>b.setAttribute("aria-pressed", b.textContent===currentCrypto?"true":"false"));
  $$("#cryptoStripTransfer .chip").forEach(b=>b.setAttribute("aria-pressed", b.textContent===transferTarget?"true":"false"));
  $$("#ewalletStripTransfer .ewbtn").forEach(b=>b.setAttribute("aria-pressed", b.dataset.key===transferTarget?"true":"false"));
}
function refreshAll(){ 
  updateCurrentRateDisplay();
  renderStrips(); 
  refreshDepot(); 
  refreshRetrait(); 
  refreshTransfer(); 
}

/* ===== Validation helpers (all fields + checkbox before Aperçu) ===== */
function requiredFilledDepot(){
  const a = $("#dep-amount-ariary").value.trim()!=="" && Number($("#dep-amount-ariary").value)>0;
  const addr = $("#dep-addr").value.trim()!=="";
  const holder = $("#dep-holder").value.trim()!=="";
  const chk = $("#dep-accept").checked;
  return a && addr && holder && chk;
}
function requiredFilledRetrait(){
  const q = $("#ret-amount-crypto").value.trim()!=="" && Number($("#ret-amount-crypto").value)>0;
  const our = $("#ret-our-addr").value.trim()!=="";
  const phone = $("#ret-phone").value.trim()!=="";
  const name = $("#ret-name").value.trim()!=="";
  const chk = $("#ret-accept").checked;
  return q && our && phone && name && chk;
}
function requiredFilledTransfert(){
  const q = $("#trf-amount-top").value.trim()!=="" && Number($("#trf-amount-top").value)>0;
  const addr = $("#trf-dest-addr").value.trim()!=="";
  const chk = $("#trf-accept").checked;
  return q && addr && chk;
}
function guardOrWarn(ok){ if(!ok){ toast("Fenoy avokoa ny saha rehetra ary cocheo ny fepetra."); } return ok; }

/* ===== PREVIEW (Confirm -> EmailJS or DEMO) ===== */
$("#dep-preview").addEventListener("click", async ()=>{
  if(!guardOrWarn(requiredFilledDepot())) return;
  if(!confirm("Hamarino tsara ny fampidiranao. Hanohy handefa?")) return;
  const payload = {
    service: "DEPOT",
    crypto: currentCrypto,
    pay_choice: payChoice,
    montant_ariary: $("#dep-amount-ariary").value,
    montant_crypto: $("#dep-amount-crypto").value,
    adresse_paiement: $("#dep-addr").value,
    nom_dans_compte: $("#dep-holder").value,
    taux: rateLine(currentCrypto),
    frais: (CONFIG.fees.depot*100).toFixed(1)+"%"
  };
  await sendEmail(payload);
});

$("#ret-preview").addEventListener("click", async ()=>{
  if(!guardOrWarn(requiredFilledRetrait())) return;
  if(!confirm("Hamarino tsara ny fampidiranao. Hanohy handefa?")) return;
  const payload = {
    service: "RETRAIT",
    crypto: currentCrypto,
    montant_crypto: $("#ret-amount-crypto").value,
    adresse_nou: $("#ret-our-addr").value,
    montant_mga: $("#ret-amount-ariary").value,
    wallet: $("#ret-wallet").value,
    telephone: $("#ret-phone").value,
    nom_dans_compte: $("#ret-name").value,
    taux: rateLine(currentCrypto),
    frais: (CONFIG.fees.retrait*100).toFixed(1)+"%"
  };
  await sendEmail(payload);
});

$("#trf-preview").addEventListener("click", async ()=>{
  if(!guardOrWarn(requiredFilledTransfert())) return;
  if(!confirm("Hamarino tsara ny fampidiranao. Hanohy handefa?")) return;
  const payload = {
    service: "TRANSFERT",
    crypto_source: currentCrypto,
    montant_source: $("#trf-amount-top").value,
    target: transferTarget,
    montant_cible: $("#trf-amount-bot").value,
    adresse_dest: $("#trf-dest-addr").value,
    taux: `1 ${currentCrypto} = ${crossRate(currentCrypto, /^[A-Z]{3,5}$/.test(transferTarget)?transferTarget:"USDT")} ${/^[A-Z]{3,5}$/.test(transferTarget)?transferTarget:"USDT"}`,
    frais: (CONFIG.fees.transfert*100).toFixed(1)+"%"
  };
  await sendEmail(payload);
});

async function sendEmail(data){
  const okConfig = CONFIG.emailjsPublicKey!=="DEMO_PUBLIC_KEY_REPLACE_ME" && CONFIG.emailjsServiceId!=="DEMO_SERVICE_ID" && CONFIG.emailjsTemplateId!=="DEMO_TEMPLATE_ID";
  try{
    if(okConfig && window.emailjs){
      await emailjs.send(CONFIG.emailjsServiceId, CONFIG.emailjsTemplateId, data);
      toast("Votre demande a été reçue. Veuillez envoyer le montant sous 15 minutes, sinon la demande sera annulée.");
    }else{
      // DEMO mode: no real send, but simulate success
      console.log("DEMO SEND ->", data);
      toast("SUCCESS (DEMO): Demande enregistrée. Envoyez le montant sous 15 minutes.");
    }
  }catch(e){
    console.error(e);
    toast("Erreur lors de l'envoi. Hamarino ny connexion na ny configuration EmailJS.", 3500);
  }
}

/* ===== Initial dep address + texts ===== */
updateDepotDest();

// Initialize the app
setupCryptoSelector();
updateRates();
setInterval(updateRates, 60000); // Update rates every minute
refreshAll();
</script>
</body>
</html>
